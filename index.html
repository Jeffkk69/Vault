<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Vault ‚Äî Budget App</title>
<meta name="theme-color" content="#c9a84c">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Vault">
<link id="pwa-manifest" rel="manifest">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #0d0f14;
    --surface: #161922;
    --surface2: #1e2330;
    --border: #252b3a;
    --gold: #c9a84c;
    --gold2: #e8c97a;
    --text: #e8eaf0;
    --text2: #8892a4;
    --red: #e05c6a;
    --green: #4caf82;
    --blue: #5b7fde;
    --purple: #8a6de0;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; min-height: 100vh; overflow-x: hidden; }

  nav { position: fixed; top: 0; left: 0; right: 0; background: rgba(13,15,20,0.95); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; height: 60px; z-index: 100; }
  .logo { font-family: 'Playfair Display', serif; font-size: 1.4rem; font-weight: 700; color: var(--gold); letter-spacing: 2px; }
  .logo span { color: var(--text2); font-size: 0.7rem; display: block; font-family: 'DM Sans'; letter-spacing: 3px; text-transform: uppercase; font-weight: 400; }
  .month-nav { display: flex; align-items: center; gap: 12px; }
  .month-nav button { background: var(--surface2); border: 1px solid var(--border); color: var(--text2); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
  .month-nav button:hover { border-color: var(--gold); color: var(--gold); }
  #currentMonth { font-size: 0.9rem; font-weight: 500; min-width: 110px; text-align: center; }

  .tabs { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(13,15,20,0.97); border-top: 1px solid var(--border); display: flex; z-index: 100; }
  .tab { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px 2px 14px; cursor: pointer; transition: all 0.2s; color: var(--text2); font-size: 0.55rem; font-weight: 500; letter-spacing: 0.5px; text-transform: uppercase; gap: 4px; border: none; background: none; }
  .tab .icon { font-size: 1.3rem; }
  .tab.active { color: var(--gold); }
  .tab.active .icon { filter: drop-shadow(0 0 6px var(--gold)); }

  main { padding: 72px 16px 90px; max-width: 500px; margin: 0 auto; }

  .section { display: none; animation: fadeIn 0.3s ease; }
  .section.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 16px; }
  .card-title { font-family: 'Playfair Display', serif; font-size: 1rem; font-weight: 600; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px; }

  .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
  .summary-card { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 16px; }
  .summary-card .label { font-size: 0.72rem; color: var(--text2); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; }
  .summary-card .amount { font-family: 'Playfair Display', serif; font-size: 1.5rem; font-weight: 700; }
  .summary-card.income .amount { color: var(--green); }
  .summary-card.expense .amount { color: var(--red); }
  .net-card { background: linear-gradient(135deg, #1a1f2e, #1e2535); border: 1px solid var(--gold); border-radius: 16px; padding: 20px; margin-bottom: 16px; text-align: center; }
  .net-card .label { font-size: 0.72rem; color: var(--gold); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 6px; }
  .net-card .amount { font-family: 'Playfair Display', serif; font-size: 2.4rem; font-weight: 700; }

  .tx-item { display: flex; align-items: center; gap: 10px; padding: 12px 0; border-bottom: 1px solid var(--border); cursor: pointer; position: relative; }
  .tx-item:last-child { border-bottom: none; }
  .tx-icon { width: 38px; height: 38px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; }
  .tx-icon.income { background: rgba(76,175,130,0.15); }
  .tx-icon.expense { background: rgba(224,92,106,0.15); }
  .tx-info { flex: 1; min-width: 0; overflow: hidden; }
  .tx-name { font-size: 0.88rem; font-weight: 500; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3; }
  .tx-cat { font-size: 0.7rem; color: var(--text2); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .tx-right { flex-shrink: 0; text-align: right; min-width: 72px; }
  .tx-date { font-size: 0.68rem; color: var(--text2); margin-top: 2px; }
  .tx-amount { font-weight: 600; font-size: 0.9rem; }
  .tx-amount.income { color: var(--green); }
  .tx-amount.expense { color: var(--red); }
  .tx-menu-btn { flex-shrink: 0; width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--text2); font-size: 1.1rem; line-height: 1; cursor: pointer; background: none; border: none; font-family: inherit; }
  .tx-menu-btn:active { background: var(--surface2); }
  .tx-checkbox { flex-shrink: 0; width: 22px; height: 22px; border-radius: 6px; border: 2px solid var(--border); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; background: transparent; }
  .tx-checkbox.checked { background: var(--red); border-color: var(--red); }
  .tx-checkbox.checked::after { content: '‚úì'; color: #fff; font-size: 0.8rem; font-weight: 700; }
  .tx-item.selected { background: rgba(224,92,106,0.06); border-radius: 10px; }
  .tx-popup { position: absolute; right: 0; top: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); z-index: 100; min-width: 140px; overflow: hidden; display: none; }
  .tx-popup.open { display: block; }
  .tx-popup-item { display: flex; align-items: center; gap: 10px; padding: 12px 16px; font-size: 0.88rem; cursor: pointer; transition: background 0.15s; }
  .tx-popup-item:hover, .tx-popup-item:active { background: var(--surface2); }
  .tx-popup-item.danger { color: var(--red); }

  .budget-item { margin-bottom: 16px; }
  .budget-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .budget-name { font-weight: 500; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
  .budget-amounts { font-size: 0.8rem; color: var(--text2); }
  .progress-bar { height: 6px; background: var(--border); border-radius: 99px; overflow: hidden; }
  .progress-fill { height: 100%; border-radius: 99px; transition: width 0.5s ease; }
  .budget-pct { font-size: 0.72rem; color: var(--text2); margin-top: 4px; text-align: right; }

  .goal-item { padding: 16px 0; border-bottom: 1px solid var(--border); }
  .goal-item:last-child { border-bottom: none; }
  .goal-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
  .goal-name { font-weight: 600; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; }
  .goal-pct { font-size: 0.8rem; color: var(--gold); font-weight: 600; }
  .goal-amounts { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text2); margin-top: 6px; }
  .goal-amounts .saved { color: var(--green); font-weight: 500; }
  .goal-contribute { margin-top: 10px; display: flex; gap: 8px; }
  .goal-contribute input { flex: 1; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 6px 10px; border-radius: 8px; font-size: 0.85rem; outline: none; }
  .goal-contribute input:focus { border-color: var(--gold); }
  .btn-sm { background: var(--gold); color: #000; border: none; border-radius: 8px; padding: 6px 14px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: background 0.2s; }
  .btn-sm:hover { background: var(--gold2); }

  .chart-container { position: relative; height: 200px; }

  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 200; display: flex; align-items: flex-end; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 24px 24px 0 0; padding: 24px 20px 40px; width: 100%; max-width: 500px; transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.34,1.56,0.64,1); max-height: 92vh; overflow-y: auto; }
  .modal-overlay.open .modal { transform: translateY(0); }
  .modal-title { font-family: 'Playfair Display', serif; font-size: 1.3rem; font-weight: 700; margin-bottom: 20px; text-align: center; }
  .form-group { margin-bottom: 14px; }
  .form-label { font-size: 0.75rem; color: var(--text2); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px; display: block; }
  .form-input, .form-select { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 12px 14px; border-radius: 10px; font-size: 0.95rem; outline: none; font-family: 'DM Sans', sans-serif; transition: border-color 0.2s; }
  .form-input:focus, .form-select:focus { border-color: var(--gold); }
  .form-select option { background: var(--surface); }
  .type-toggle { display: flex; background: var(--bg); border-radius: 10px; border: 1px solid var(--border); overflow: hidden; }
  .type-btn { flex: 1; padding: 11px; text-align: center; cursor: pointer; font-weight: 500; font-size: 0.9rem; transition: all 0.2s; border: none; font-family: 'DM Sans'; color: var(--text2); background: transparent; }
  .type-btn.expense.active { background: var(--red); color: #fff; }
  .type-btn.income.active { background: var(--green); color: #fff; }
  .btn-primary { width: 100%; background: var(--gold); color: #000; border: none; border-radius: 12px; padding: 16px; font-size: 1rem; font-weight: 700; cursor: pointer; margin-top: 8px; font-family: 'DM Sans'; letter-spacing: 0.5px; transition: background 0.2s, transform 0.1s; }
  .btn-primary:hover { background: var(--gold2); }
  .btn-primary:active { transform: scale(0.98); }
  .btn-close { position: absolute; top: 16px; right: 16px; background: var(--surface2); border: 1px solid var(--border); color: var(--text2); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; z-index: 10; }
  .btn-outline { width: 100%; background: transparent; color: var(--text2); border: 1px solid var(--border); border-radius: 12px; padding: 14px; font-size: 0.95rem; font-weight: 600; cursor: pointer; margin-top: 8px; font-family: 'DM Sans'; transition: all 0.2s; }
  .btn-outline:hover { border-color: var(--gold); color: var(--gold); }

  .modal2-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 300; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
  .modal2-overlay.open { opacity: 1; pointer-events: all; }
  .modal2 { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 24px 20px; width: 100%; max-width: 400px; position: relative; transform: scale(0.9); transition: transform 0.3s; max-height: 90vh; overflow-y: auto; }
  .modal2-overlay.open .modal2 { transform: scale(1); }

  .fab { position: fixed; bottom: 80px; right: 20px; z-index: 99; width: 56px; height: 56px; border-radius: 50%; background: var(--gold); color: #000; border: none; font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 20px rgba(201,168,76,0.4); display: flex; align-items: center; justify-content: center; transition: transform 0.2s, box-shadow 0.2s; }
  .fab:hover { transform: scale(1.1); box-shadow: 0 6px 28px rgba(201,168,76,0.5); }
  .fab:active { transform: scale(0.95); }

  .chip { display: inline-flex; align-items: center; gap: 4px; background: var(--surface2); border: 1px solid var(--border); color: var(--text2); font-size: 0.72rem; padding: 4px 10px; border-radius: 99px; cursor: pointer; transition: all 0.2s; font-weight: 500; }
  .chip:hover, .chip.active { border-color: var(--gold); color: var(--gold); background: rgba(201,168,76,0.08); }
  .chips-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }

  .empty { text-align: center; padding: 40px 20px; color: var(--text2); }
  .empty .empty-icon { font-size: 3rem; margin-bottom: 12px; }
  .empty p { font-size: 0.9rem; }

  .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .section-title { font-family: 'Playfair Display', serif; font-size: 1.5rem; font-weight: 700; }
  .section-sub { font-size: 0.8rem; color: var(--text2); margin-top: 2px; }
  .add-link { color: var(--gold); font-size: 0.82rem; font-weight: 600; cursor: pointer; }
  .cat-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

  /* CSV IMPORT */
  .import-banner { background: linear-gradient(135deg, rgba(201,168,76,0.12), rgba(91,127,222,0.1)); border: 1px solid rgba(201,168,76,0.3); border-radius: 14px; padding: 16px; display: flex; align-items: center; gap: 14px; margin-bottom: 16px; cursor: pointer; transition: all 0.2s; }
  .import-banner:hover { border-color: var(--gold); transform: translateY(-1px); }
  .import-banner .ib-icon { font-size: 2rem; flex-shrink: 0; }
  .import-banner .ib-title { font-weight: 600; font-size: 0.95rem; color: var(--gold); }
  .import-banner .ib-sub { font-size: 0.78rem; color: var(--text2); margin-top: 2px; }

  .drop-zone { border: 2px dashed var(--border); border-radius: 16px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.3s; position: relative; background: var(--bg); }
  .drop-zone:hover, .drop-zone.dragging { border-color: var(--gold); background: rgba(201,168,76,0.05); }
  .drop-zone .drop-icon { font-size: 2.5rem; margin-bottom: 12px; }
  .drop-zone .drop-title { font-size: 1rem; font-weight: 600; margin-bottom: 6px; }
  .drop-zone .drop-sub { font-size: 0.82rem; color: var(--text2); line-height: 1.5; }
  .drop-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }

  .bank-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
  .bank-chip { padding: 6px 14px; border-radius: 99px; border: 1px solid var(--border); font-size: 0.78rem; cursor: pointer; transition: all 0.2s; color: var(--text2); background: var(--surface2); }
  .bank-chip:hover, .bank-chip.active { border-color: var(--gold); color: var(--gold); background: rgba(201,168,76,0.08); }

  .col-map-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

  .steps { display: flex; align-items: flex-start; margin-bottom: 24px; }
  .step { flex-shrink: 0; text-align: center; }
  .step-num { width: 28px; height: 28px; border-radius: 50%; background: var(--surface2); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; margin: 0 auto 4px; color: var(--text2); transition: all 0.3s; }
  .step.active .step-num { background: var(--gold); color: #000; border-color: var(--gold); }
  .step.done .step-num { background: var(--green); color: #fff; border-color: var(--green); }
  .step-label { font-size: 0.62rem; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; }
  .step.active .step-label { color: var(--gold); }
  .step-line { flex: 1; height: 1px; background: var(--border); margin-top: 14px; }

  .preview-wrap { overflow-x: auto; margin-bottom: 12px; border-radius: 10px; border: 1px solid var(--border); max-height: 280px; overflow-y: auto; }
  .preview-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
  .preview-table th { background: var(--surface2); color: var(--text2); padding: 8px 10px; text-align: left; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; font-size: 0.7rem; white-space: nowrap; position: sticky; top: 0; }
  .preview-table td { padding: 7px 10px; border-top: 1px solid var(--border); color: var(--text); }
  .preview-table tr:hover td { background: var(--surface2); }
  .preview-table td select { background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 6px; padding: 3px 6px; font-size: 0.72rem; font-family: 'DM Sans'; max-width: 130px; }

  .ai-status { display: flex; align-items: center; gap: 10px; padding: 12px 16px; border-radius: 10px; background: rgba(91,127,222,0.1); border: 1px solid rgba(91,127,222,0.3); font-size: 0.85rem; margin-bottom: 16px; color: var(--blue); }
  .ai-status .spinner { width: 18px; height: 18px; border: 2px solid rgba(91,127,222,0.3); border-top-color: var(--blue); border-radius: 50%; animation: spin 0.8s linear infinite; flex-shrink: 0; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .ai-done { background: rgba(76,175,130,0.1); border-color: rgba(76,175,130,0.3); color: var(--green); }
  .ai-error { background: rgba(224,92,106,0.1); border-color: rgba(224,92,106,0.3); color: var(--red); }

  /* Split transactions */
  .split-toggle { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; transition: border-color 0.2s; margin-bottom: 14px; }
  .split-toggle:hover { border-color: var(--gold); }
  .split-toggle-label { font-size: 0.85rem; color: var(--text2); }
  .split-toggle-sw { width: 36px; height: 20px; background: var(--border); border-radius: 99px; position: relative; transition: background 0.2s; }
  .split-toggle-sw.on { background: var(--gold); }
  .split-toggle-sw::after { content:''; position:absolute; top:3px; left:3px; width:14px; height:14px; background:#fff; border-radius:50%; transition: left 0.2s; }
  .split-toggle-sw.on::after { left: 19px; }
  .split-section { display: none; }
  .split-section.visible { display: block; }
  .split-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
  .split-row select { flex: 2; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 9px 10px; border-radius: 10px; font-size: 0.85rem; outline: none; font-family: 'DM Sans'; }
  .split-row select:focus { border-color: var(--gold); }
  .split-row input { flex: 1; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 9px 10px; border-radius: 10px; font-size: 0.85rem; outline: none; font-family: 'DM Sans'; min-width: 0; }
  .split-row input:focus { border-color: var(--gold); }
  .split-del { color: var(--text2); cursor: pointer; font-size: 1.1rem; flex-shrink: 0; padding: 4px; line-height: 1; }
  .split-del:hover { color: var(--red); }
  .split-remaining { font-size: 0.8rem; margin-bottom: 10px; padding: 8px 12px; border-radius: 8px; }
  .split-remaining.ok { background: rgba(76,175,130,0.1); color: var(--green); }
  .split-remaining.over { background: rgba(224,92,106,0.1); color: var(--red); }
  .split-remaining.under { background: rgba(201,168,76,0.1); color: var(--gold); }
  .add-split-btn { background: transparent; border: 1px dashed var(--border); color: var(--text2); border-radius: 10px; padding: 8px 14px; font-size: 0.82rem; cursor: pointer; width: 100%; margin-bottom: 12px; transition: all 0.2s; font-family: 'DM Sans'; }
  .add-split-btn:hover { border-color: var(--gold); color: var(--gold); }

  /* Category manager */
  .cat-manage-row { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border); }
  .cat-manage-row:last-child { border-bottom: none; }
  .cat-swatch { width: 32px; height: 32px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; }
  .cat-manage-name { flex: 1; font-size: 0.9rem; font-weight: 500; }
  .cat-manage-type { font-size: 0.7rem; padding: 2px 8px; border-radius: 99px; font-weight: 600; }
  .cat-manage-type.expense { background: rgba(224,92,106,0.15); color: var(--red); }
  .cat-manage-type.income { background: rgba(76,175,130,0.15); color: var(--green); }
  .cat-del-btn { color: var(--text2); cursor: pointer; font-size: 1rem; padding: 4px; transition: color 0.2s; background: none; border: none; }
  .cat-del-btn:hover { color: var(--red); }
  .color-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 6px; margin-top: 6px; }
  .color-swatch { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.15s, border-color 0.15s; }
  .color-swatch.selected { border-color: #fff; transform: scale(1.15); }
  .nav-settings-btn { background: var(--surface2); border: 1px solid var(--border); color: var(--text2); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
  .nav-settings-btn:hover { border-color: var(--gold); color: var(--gold); }

  /* Accounts */
  .account-card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 16px; position: relative; overflow: hidden; }
  .account-card::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; }
  .account-card.mortgage::before { background: linear-gradient(90deg, #5b7fde, #8a6de0); }
  .account-card.car::before { background: linear-gradient(90deg, #4caf82, #5b7fde); }
  .account-card.student::before { background: linear-gradient(90deg, #c9a84c, #e07c3a); }
  .account-card.credit::before { background: linear-gradient(90deg, #e05c6a, #8a6de0); }
  .account-card.personal::before { background: linear-gradient(90deg, #3ab8c9, #4caf82); }
  .account-card.other::before { background: linear-gradient(90deg, #8892a4, #5b7fde); }
  .account-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:14px; }
  .account-name { font-family:'Playfair Display',serif; font-size:1.1rem; font-weight:700; }
  .account-type-badge { font-size:0.68rem; letter-spacing:1px; text-transform:uppercase; color:var(--text2); margin-top:2px; }
  .account-actions { display:flex; gap:8px; }
  .account-action-btn { background:var(--surface2); border:1px solid var(--border); color:var(--text2); width:30px; height:30px; border-radius:8px; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:0.85rem; transition:all 0.2s; }
  .account-action-btn:hover { border-color:var(--gold); color:var(--gold); }
  .account-balance { font-family:'Playfair Display',serif; font-size:1.8rem; font-weight:700; color:var(--red); margin-bottom:4px; }
  .account-meta { display:flex; gap:20px; margin-bottom:14px; }
  .account-meta-item { font-size:0.78rem; color:var(--text2); }
  .account-meta-item strong { display:block; color:var(--text); font-size:0.88rem; font-weight:600; }
  .account-progress { height:6px; background:var(--border); border-radius:99px; overflow:hidden; margin-bottom:6px; }
  .account-progress-fill { height:100%; border-radius:99px; background:linear-gradient(90deg,#4caf82,#c9a84c); transition:width 0.5s; }
  .account-progress-label { display:flex; justify-content:space-between; font-size:0.72rem; color:var(--text2); margin-bottom:14px; }
  .payoff-box { background:var(--bg); border:1px solid var(--border); border-radius:12px; padding:14px; }
  .payoff-box-title { font-size:0.72rem; letter-spacing:1px; text-transform:uppercase; color:var(--gold); font-weight:600; margin-bottom:10px; }
  .payoff-scenarios { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .payoff-scenario { background:var(--surface2); border-radius:10px; padding:10px; text-align:center; }
  .payoff-scenario .ps-label { font-size:0.68rem; color:var(--text2); margin-bottom:4px; text-transform:uppercase; letter-spacing:0.5px; }
  .payoff-scenario .ps-date { font-size:0.88rem; font-weight:700; color:var(--text); }
  .payoff-scenario .ps-savings { font-size:0.72rem; color:var(--green); margin-top:2px; }
  .payoff-scenario.highlight { border:1px solid rgba(201,168,76,0.4); background:rgba(201,168,76,0.08); }
  .payoff-scenario.highlight .ps-date { color:var(--gold); }
  .custom-payment-row { display:flex; gap:8px; align-items:center; margin-top:10px; }
  .custom-payment-row input { flex:1; background:var(--bg); border:1px solid var(--border); color:var(--text); padding:8px 12px; border-radius:8px; font-size:0.85rem; outline:none; font-family:'DM Sans'; }
  .custom-payment-row input:focus { border-color:var(--gold); }
  .custom-payment-row .ps-custom { flex:1; background:var(--surface2); border-radius:10px; padding:10px; text-align:center; }
  .acct-summary-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:16px; }
  .acct-summary-card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:12px; text-align:center; }
  .acct-summary-card .label { font-size:0.65rem; color:var(--text2); letter-spacing:1px; text-transform:uppercase; margin-bottom:6px; }
  .acct-summary-card .value { font-family:'Playfair Display',serif; font-size:1.1rem; font-weight:700; }

  /* Amortization modal */
  .amort-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.85); backdrop-filter:blur(6px); z-index:400; display:flex; flex-direction:column; opacity:0; pointer-events:none; transition:opacity 0.3s; }
  .amort-overlay.open { opacity:1; pointer-events:all; }
  .amort-header { background:var(--surface); border-bottom:1px solid var(--border); padding:16px 20px; display:flex; align-items:center; justify-content:space-between; flex-shrink:0; }
  .amort-title { font-family:'Playfair Display',serif; font-size:1.1rem; font-weight:700; }
  .amort-subtitle { font-size:0.75rem; color:var(--text2); margin-top:2px; }
  .amort-tabs { display:flex; gap:8px; padding:12px 16px; background:var(--surface); border-bottom:1px solid var(--border); flex-shrink:0; overflow-x:auto; }
  .amort-tab { padding:6px 14px; border-radius:99px; font-size:0.78rem; font-weight:600; cursor:pointer; border:1px solid var(--border); color:var(--text2); background:transparent; white-space:nowrap; transition:all 0.2s; font-family:'DM Sans'; }
  .amort-tab.active { background:var(--gold); color:#000; border-color:var(--gold); }
  .amort-body { flex:1; overflow-y:auto; padding:16px; }
  .amort-summary { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:16px; }
  .amort-stat { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:12px; text-align:center; }
  .amort-stat .as-label { font-size:0.65rem; color:var(--text2); letter-spacing:1px; text-transform:uppercase; margin-bottom:4px; }
  .amort-stat .as-value { font-family:'Playfair Display',serif; font-size:1rem; font-weight:700; }
  .amort-year-group { margin-bottom:4px; }
  .amort-year-header { display:flex; align-items:center; justify-content:space-between; padding:10px 14px; background:var(--surface2); border-radius:10px; cursor:pointer; margin-bottom:4px; user-select:none; }
  .amort-year-label { font-weight:700; font-size:0.88rem; color:var(--gold); }
  .amort-year-meta { font-size:0.75rem; color:var(--text2); }
  .amort-year-toggle { color:var(--text2); font-size:0.8rem; transition:transform 0.2s; }
  .amort-year-toggle.open { transform:rotate(180deg); }
  .amort-rows { display:none; }
  .amort-rows.open { display:block; }
  .amort-row { display:grid; grid-template-columns:32px 1fr 1fr 1fr 1fr; gap:4px; align-items:center; padding:8px 10px; border-bottom:1px solid rgba(37,43,58,0.6); font-size:0.78rem; }
  .amort-row:last-child { border-bottom:none; }
  .amort-row.current-month { background:rgba(201,168,76,0.08); border-radius:8px; }
  .amort-row.paid { opacity:0.55; }
  .amort-row.custom-payment { background:rgba(76,175,130,0.08); }
  .amort-col-hdr { display:grid; grid-template-columns:32px 1fr 1fr 1fr 1fr; gap:4px; padding:6px 10px; font-size:0.65rem; color:var(--text2); text-transform:uppercase; letter-spacing:0.5px; font-weight:600; border-bottom:1px solid var(--border); margin-bottom:4px; }
  .amort-pmt-cell { display:flex; align-items:center; gap:4px; }
  .amort-edit-btn { background:none; border:none; color:var(--text2); cursor:pointer; font-size:0.75rem; padding:2px 4px; border-radius:4px; transition:all 0.15s; line-height:1; }
  .amort-edit-btn:hover { color:var(--gold); background:rgba(201,168,76,0.1); }
  .amort-edit-input { width:70px; background:var(--surface2); border:1px solid var(--gold); color:var(--text); padding:3px 6px; border-radius:6px; font-size:0.78rem; outline:none; font-family:'DM Sans'; }
  .amort-save-btn { background:var(--gold); color:#000; border:none; border-radius:5px; padding:3px 7px; font-size:0.72rem; font-weight:700; cursor:pointer; font-family:'DM Sans'; }
  .amort-cancel-btn { background:var(--surface2); color:var(--text2); border:1px solid var(--border); border-radius:5px; padding:3px 7px; font-size:0.72rem; cursor:pointer; font-family:'DM Sans'; }
  .amort-badge { font-size:0.65rem; padding:1px 6px; border-radius:99px; font-weight:600; margin-left:2px; }
  .amort-badge.extra { background:rgba(76,175,130,0.2); color:var(--green); }
  .amort-badge.reduced { background:rgba(224,92,106,0.2); color:var(--red); }
  .scenario-compare { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:16px; margin-bottom:12px; }
  .scenario-compare h3 { font-size:0.78rem; color:var(--gold); text-transform:uppercase; letter-spacing:1px; margin-bottom:12px; font-weight:600; }
  .scenario-row { display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid var(--border); }
  .scenario-row:last-child { border-bottom:none; }
  .scenario-name { font-size:0.85rem; font-weight:500; }
  .scenario-details { text-align:right; }
  .scenario-date { font-size:0.88rem; font-weight:700; color:var(--text); }
  .scenario-saving { font-size:0.72rem; color:var(--green); margin-top:1px; }
  .scenario-custom-row { display:flex; gap:8px; margin-top:12px; align-items:center; }
  .scenario-custom-row input { flex:1; background:var(--bg); border:1px solid var(--border); color:var(--text); padding:10px 12px; border-radius:10px; font-size:0.88rem; outline:none; font-family:'DM Sans'; }
  .scenario-custom-row input:focus { border-color:var(--gold); }
  .scenario-custom-result { background:var(--surface2); border-radius:10px; padding:10px 14px; margin-top:8px; font-size:0.82rem; display:none; }
</style>
</head>
<body>

<nav>
  <div class="logo">VAULT<span>Personal Finance</span></div>
  <div style="display:flex;align-items:center;gap:10px;">
    <div class="month-nav">
      <button onclick="changeMonth(-1)">&#8249;</button>
      <span id="currentMonth"></span>
      <button onclick="changeMonth(1)">&#8250;</button>
    </div>
    <button class="nav-settings-btn" onclick="openCatManager()" title="Manage Categories">‚öôÔ∏è</button>
    <button class="nav-settings-btn" onclick="exportData()" title="Save Data to File">üíæ</button>
    <button class="nav-settings-btn" onclick="document.getElementById('import-data-input').click()" title="Load Data from File">üìÇ</button>
    <input type="file" id="import-data-input" accept=".json" style="display:none;" onchange="importData(this)">
  </div>
</nav>

<main>
  <!-- DASHBOARD -->
  <div class="section active" id="sec-dashboard">
    <div class="section-header">
      <div><div class="section-title">Overview</div><div class="section-sub" id="dash-sub"></div></div>
    </div>
    <div class="net-card" onclick="startEditNetBalance()" style="cursor:pointer;" title="Tap to set starting balance">
      <div class="label">NET BALANCE <span style="font-size:0.6rem;opacity:0.5;margin-left:4px;">‚úèÔ∏è</span></div>
      <div class="amount" id="net-balance">$0</div>
      <div id="net-balance-edit" style="display:none;margin-top:10px;" onclick="event.stopPropagation()">
        <div style="font-size:0.72rem;color:var(--text2);margin-bottom:6px;">Set starting/current balance (added to this month's transactions)</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="starting-balance-input" type="number" step="0.01" placeholder="0.00"
            style="flex:1;background:rgba(255,255,255,0.1);border:1px solid var(--gold);color:#fff;padding:8px 12px;border-radius:10px;font-size:1rem;outline:none;font-family:'DM Sans';" />
          <button onclick="saveStartingBalance()" style="background:var(--gold);color:#000;border:none;border-radius:10px;padding:8px 14px;font-weight:700;font-size:0.85rem;cursor:pointer;font-family:'DM Sans';">Save</button>
          <button onclick="cancelEditNetBalance()" style="background:rgba(255,255,255,0.1);color:#fff;border:none;border-radius:10px;padding:8px 14px;font-size:0.85rem;cursor:pointer;font-family:'DM Sans';">Cancel</button>
        </div>
      </div>
    </div>
    <div class="summary-grid">
      <div class="summary-card income"><div class="label">Income</div><div class="amount" id="total-income">$0</div></div>
      <div class="summary-card expense"><div class="label">Expenses</div><div class="amount" id="total-expense">$0</div></div>
    </div>
    <div class="card">
      <div class="card-title">Monthly Breakdown</div>
      <div class="chart-container"><canvas id="monthChart"></canvas></div>
    </div>
    <div class="card">
      <div class="card-title" style="display:flex;justify-content:space-between;align-items:center;">
        Recent Transactions <span class="add-link" onclick="switchTab('transactions')">See all</span>
      </div>
      <div id="recent-tx"></div>
    </div>
  </div>

  <!-- TRANSACTIONS -->
  <div class="section" id="sec-transactions">
    <div class="section-header">
      <div><div class="section-title">Transactions</div></div>
      <div style="display:flex;gap:12px;align-items:center;">
        <span class="add-link" id="select-mode-btn" onclick="toggleSelectMode()">‚òë Select</span>
        <span class="add-link" onclick="reCleanAllDescriptions()" title="Clean up imported descriptions">üßπ Re-clean</span>
      </div>
    </div>
    <div class="import-banner" onclick="openImport()">
      <div class="ib-icon">üè¶</div>
      <div style="flex:1;">
        <div class="ib-title">Import Bank Transactions</div>
        <div class="ib-sub">Drop a CSV from your bank ‚Äî AI categorizes everything automatically</div>
      </div>
      <span style="color:var(--gold);font-size:1.2rem;">&#8250;</span>
    </div>
    <div class="chips-row" id="tx-filter-chips"></div>
    <div class="card" id="all-tx-list"></div>
  </div>

  <!-- MULTI-DELETE BAR -->
  <div id="multi-delete-bar" style="display:none;position:fixed;bottom:60px;left:0;right:0;z-index:200;padding:12px 16px;background:var(--surface);border-top:1px solid var(--border);display:none;align-items:center;justify-content:space-between;gap:12px;">
    <span id="select-count-label" style="font-size:0.88rem;color:var(--text2);">0 selected</span>
    <div style="display:flex;gap:8px;">
      <button onclick="selectAllTx()" style="background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 14px;font-size:0.82rem;cursor:pointer;font-family:'DM Sans';">Select All</button>
      <button onclick="deleteSelectedTx()" style="background:var(--red);color:#fff;border:none;border-radius:10px;padding:8px 16px;font-size:0.82rem;font-weight:700;cursor:pointer;font-family:'DM Sans';">üóë Delete</button>
    </div>
  </div>

  <!-- BUDGET -->
  <div class="section" id="sec-budget">
    <div class="section-header">
      <div><div class="section-title">Budget</div><div class="section-sub">Spending limits by category</div></div>
      <span class="add-link" onclick="openAddBudget()">+ Add</span>
    </div>
    <div id="budget-list"></div>
    <div class="card" style="margin-top:16px;">
      <div class="card-title">Spending by Category</div>
      <div class="chart-container"><canvas id="budgetChart"></canvas></div>
    </div>
  </div>

  <!-- GOALS -->
  <div class="section" id="sec-goals">
    <div class="section-header">
      <div><div class="section-title">Savings Goals</div></div>
      <span class="add-link" onclick="openAddGoal()">+ Add</span>
    </div>
    <div id="goals-list"></div>
  </div>

  <!-- ACCOUNTS -->
  <div class="section" id="sec-accounts">
    <div class="section-header">
      <div><div class="section-title">Accounts</div><div class="section-sub">Loans & debt tracking</div></div>
      <span class="add-link" onclick="openAccountModal()">+ Add</span>
    </div>
    <div class="acct-summary-grid" id="acct-summary"></div>
    <div id="accounts-list"></div>
  </div>
</main>

<div class="tabs">
  <button class="tab active" onclick="switchTab('dashboard')"><span class="icon">üìä</span>Dashboard</button>
  <button class="tab" onclick="switchTab('transactions')"><span class="icon">üí≥</span>Transactions</button>
  <button class="tab" onclick="switchTab('budget')"><span class="icon">üéØ</span>Budget</button>
  <button class="tab" onclick="switchTab('goals')"><span class="icon">‚≠ê</span>Goals</button>
  <button class="tab" onclick="switchTab('accounts')"><span class="icon">üè¶</span>Accounts</button>
</div>

<button class="fab" onclick="currentTab==='accounts'?openAccountModal():openAddTx()">+</button>

<!-- ADD TRANSACTION MODAL -->
<div class="modal-overlay" id="tx-modal">
  <div class="modal" style="position:relative;">
    <button class="btn-close" onclick="closeTxModal()">&#10005;</button>
    <div class="modal-title" id="tx-modal-title">Add Transaction</div>
    <input type="hidden" id="tx-edit-id" value="" />
    <div class="form-group">
      <div class="type-toggle">
        <button class="type-btn expense active" id="btn-expense" onclick="setType('expense')">Expense</button>
        <button class="type-btn income" id="btn-income" onclick="setType('income')">Income</button>
      </div>
    </div>
    <div class="form-group"><label class="form-label">Description</label><input class="form-input" id="tx-name" placeholder="e.g. Coffee, Salary..." /></div>
    <div class="form-group"><label class="form-label">Amount ($)</label><input class="form-input" id="tx-amount" type="number" min="0" step="0.01" placeholder="0.00" oninput="updateSplitRemaining()" /></div>
    <div class="form-group"><label class="form-label">Date</label><input class="form-input" id="tx-date" type="date" /></div>

    <!-- Single category (shown when not splitting) -->
    <div id="single-cat-group" class="form-group"><label class="form-label">Category</label><select class="form-select" id="tx-category"></select></div>

    <!-- Split toggle -->
    <div class="split-toggle" onclick="toggleSplit()">
      <span class="split-toggle-label">‚úÇÔ∏è Split across categories</span>
      <div class="split-toggle-sw" id="split-sw"></div>
    </div>

    <!-- Split section -->
    <div class="split-section" id="split-section">
      <div class="split-remaining under" id="split-remaining">Enter total amount above</div>
      <div id="split-rows"></div>
      <button class="add-split-btn" onclick="addSplitRow()">+ Add category split</button>
    </div>

    <div class="form-group">
      <label class="form-label">Notes <span style="color:var(--text2);font-weight:400;">(optional)</span></label>
      <textarea class="form-input" id="tx-notes" placeholder="Add a note‚Ä¶" rows="2" style="resize:none;line-height:1.5;"></textarea>
    </div>

    <button class="btn-primary" onclick="saveTx()">Save Transaction</button>
  </div>
</div>

<!-- ADD BUDGET MODAL -->
<div class="modal2-overlay" id="budget-modal">
  <div class="modal2">
    <button class="btn-close" onclick="closeBudgetModal()">&#10005;</button>
    <div style="font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:700;margin-bottom:20px;text-align:center;">Set Budget Limit</div>
    <div class="form-group"><label class="form-label">Category</label><select class="form-select" id="budget-cat"></select></div>
    <div class="form-group"><label class="form-label">Monthly Limit ($)</label><input class="form-input" id="budget-limit" type="number" min="0" step="1" placeholder="500" /></div>
    <button class="btn-primary" onclick="saveBudget()">Set Limit</button>
  </div>
</div>

<!-- ADD GOAL MODAL -->
<div class="modal2-overlay" id="goal-modal">
  <div class="modal2">
    <button class="btn-close" onclick="closeGoalModal()">&#10005;</button>
    <div style="font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:700;margin-bottom:20px;text-align:center;">New Savings Goal</div>
    <div class="form-group"><label class="form-label">Goal Name</label><input class="form-input" id="goal-name" placeholder="e.g. Emergency Fund, Vacation..." /></div>
    <div class="form-group"><label class="form-label">Target Amount ($)</label><input class="form-input" id="goal-target" type="number" min="0" step="1" placeholder="5000" /></div>
    <div class="form-group">
      <label class="form-label">Icon</label>
      <select class="form-select" id="goal-icon">
        <option value="üèñÔ∏è">üèñÔ∏è Vacation</option><option value="üè†">üè† Home</option><option value="üöó">üöó Car</option>
        <option value="üõ°Ô∏è">üõ°Ô∏è Emergency Fund</option><option value="üìö">üìö Education</option>
        <option value="üíç">üíç Wedding</option><option value="üíª">üíª Tech</option><option value="‚≠ê">‚≠ê Other</option>
      </select>
    </div>
    <button class="btn-primary" onclick="saveGoal()">Create Goal</button>
  </div>
</div>

<!-- CSV IMPORT MODAL -->
<div class="modal-overlay" id="import-modal">
  <div class="modal" style="position:relative;">
    <button class="btn-close" onclick="closeImport()">&#10005;</button>
    <div class="modal-title">Import from Bank</div>

    <div class="steps" id="import-steps">
      <div class="step active" id="step-ind-0"><div class="step-num">1</div><div class="step-label">Upload</div></div>
      <div class="step-line"></div>
      <div class="step" id="step-ind-1"><div class="step-num">2</div><div class="step-label">Map</div></div>
      <div class="step-line"></div>
      <div class="step" id="step-ind-2"><div class="step-num">3</div><div class="step-label">AI Review</div></div>
      <div class="step-line"></div>
      <div class="step" id="step-ind-3"><div class="step-num">4</div><div class="step-label">Done</div></div>
    </div>

    <!-- Step 0: Upload -->
    <div id="import-step-0">
      <p style="font-size:0.85rem;color:var(--text2);margin-bottom:16px;line-height:1.6;">Download a CSV statement from your bank's website and drop it here. Works with Chase, Bank of America, Wells Fargo, Capital One, and most other banks.</p>
      
      <!-- Auto-categorization note -->
      <div style="background:rgba(76,175,130,0.08);border:1px solid rgba(76,175,130,0.25);border-radius:12px;padding:14px;margin-bottom:16px;">
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-size:1rem;">‚ö°</span>
          <span style="font-size:0.82rem;font-weight:600;color:var(--green);">Auto-Categorization</span>
        </div>
        <p style="font-size:0.78rem;color:var(--text2);margin-top:6px;line-height:1.5;">Transactions are automatically categorized using built-in rules. Review and adjust in the next step.</p>
      </div>

      <div style="margin-bottom:14px;">
        <div class="form-label" style="margin-bottom:8px;">Quick preset (optional)</div>
        <div class="bank-chips">
          <span class="bank-chip" onclick="applyPreset(this,'chase')">üè¶ Chase</span>
          <span class="bank-chip" onclick="applyPreset(this,'bofa')">üè¶ Bank of America</span>
          <span class="bank-chip" onclick="applyPreset(this,'wells')">üè¶ Wells Fargo</span>
          <span class="bank-chip" onclick="applyPreset(this,'capital')">üè¶ Capital One</span>
          <span class="bank-chip" onclick="applyPreset(this,'lmcu')">üè¶ LMCU</span>
          <span class="bank-chip" onclick="applyPreset(this,'generic')">üìÑ Generic CSV</span>
        </div>
      </div>
      <div id="bank-tip"></div>
      <div class="drop-zone" id="drop-zone">
        <input type="file" accept=".csv,.txt" id="csv-file-input" onchange="handleFileSelect(this.files[0])">
        <div class="drop-icon">üìÇ</div>
        <div class="drop-title">Drop your CSV file here</div>
        <div class="drop-sub">or click to browse<br><span style="font-size:0.75rem;opacity:0.6;">Supports .csv and .txt files</span></div>
      </div>
    </div>

    <!-- Step 1: Column Mapping -->
    <div id="import-step-1" style="display:none;">
      <p style="font-size:0.85rem;color:var(--text2);margin-bottom:16px;">Match your CSV columns to the right fields. We've auto-detected below ‚Äî adjust if needed.</p>
      <div class="col-map-grid" id="col-map-grid"></div>
      <div class="form-group" style="margin-top:8px;">
        <label class="form-label">Amount interpretation</label>
        <select class="form-select" id="amount-format" onchange="colMap.format=this.value">
          <option value="negative">Expenses negative, deposits positive (‚àí45.00 / +1200.00)</option>
          <option value="flipped">Deposits negative, expenses positive (some credit unions)</option>
          <option value="positive">All positive ‚Äî detect income by description keywords</option>
        </select>
      </div>
      <div style="margin-top:12px;padding:12px;background:var(--bg);border-radius:10px;border:1px solid var(--border);">
        <div class="form-label" style="margin-bottom:8px;">Preview (first 3 rows)</div>
        <div id="col-preview" style="font-size:0.78rem;color:var(--text2);"></div>
      </div>
      <button class="btn-primary" style="margin-top:16px;" onclick="goToStep2()">Continue ‚Äî AI will categorize &#8594;</button>
      <button class="btn-outline" onclick="goToStep(0)">&#8592; Back</button>
    </div>

    <!-- Step 2: AI Categorization & Preview -->
    <div id="import-step-2" style="display:none;">
      <div id="import-diag"></div>
      <div id="ai-status-box"></div>
      <p style="font-size:0.85rem;color:var(--text2);margin-bottom:12px;">Review and adjust categories. Click any dropdown to change.</p>
      <div class="preview-wrap">
        <table class="preview-table">
          <thead><tr><th>Date</th><th>Description</th><th>Amount</th><th>Category</th></tr></thead>
          <tbody id="preview-tbody"></tbody>
        </table>
      </div>
      <div style="font-size:0.78rem;color:var(--text2);margin-bottom:12px;" id="import-count"></div>
      <button class="btn-primary" onclick="confirmImport()">Import All Transactions</button>
      <button class="btn-outline" onclick="goToStep(1)">&#8592; Back</button>
    </div>

    <!-- Step 3: Done -->
    <div id="import-step-3" style="display:none;text-align:center;padding:20px 0;">
      <div style="font-size:4rem;margin-bottom:16px;">‚úÖ</div>
      <div style="font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:700;margin-bottom:8px;">Import Complete!</div>
      <div id="import-done-msg" style="color:var(--text2);font-size:0.9rem;margin-bottom:24px;"></div>
      <button class="btn-primary" onclick="closeImport();switchTab('transactions')">View Transactions</button>
    </div>
  </div>
</div>

<!-- CATEGORY MANAGER MODAL -->
<div class="modal2-overlay" id="cat-modal">
  <div class="modal2" style="max-width:480px;">
    <button class="btn-close" onclick="closeCatManager()">&#10005;</button>
    <div style="font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:700;margin-bottom:6px;text-align:center;">Manage Categories</div>
    <p style="font-size:0.8rem;color:var(--text2);text-align:center;margin-bottom:20px;">Add custom categories or view built-in ones</p>

    <!-- Add new category -->
    <div style="background:var(--bg);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:20px;">
      <div style="font-size:0.75rem;color:var(--gold);letter-spacing:1px;text-transform:uppercase;font-weight:600;margin-bottom:12px;">New Category</div>
      <div style="display:grid;grid-template-columns:60px 1fr;gap:10px;margin-bottom:10px;">
        <div class="form-group" style="margin:0;">
          <label class="form-label">Icon</label>
          <input class="form-input" id="newcat-icon" placeholder="üè∑Ô∏è" style="text-align:center;font-size:1.3rem;padding:8px;" maxlength="2" />
        </div>
        <div class="form-group" style="margin:0;">
          <label class="form-label">Name</label>
          <input class="form-input" id="newcat-name" placeholder="Category name..." />
        </div>
      </div>
      <div class="form-group" style="margin-bottom:10px;">
        <label class="form-label">Type</label>
        <div class="type-toggle">
          <button class="type-btn expense active" id="newcat-expense-btn" onclick="setNewCatType('expense')">Expense</button>
          <button class="type-btn income" id="newcat-income-btn" onclick="setNewCatType('income')">Income</button>
        </div>
      </div>
      <div class="form-group" style="margin-bottom:12px;">
        <label class="form-label">Color</label>
        <div class="color-grid" id="color-grid"></div>
      </div>
      <button class="btn-primary" style="margin-top:0;" onclick="saveNewCategory()">Add Category</button>
    </div>

    <!-- Existing categories -->
    <div style="font-size:0.75rem;color:var(--text2);letter-spacing:1px;text-transform:uppercase;font-weight:600;margin-bottom:10px;">Your Categories</div>
    <div id="cat-manager-list"></div>
  </div>
</div>

<!-- AMORTIZATION MODAL (full screen) -->
<div class="amort-overlay" id="amort-overlay">
  <div class="amort-header">
    <div>
      <div class="amort-title" id="amort-modal-title">Amortization Schedule</div>
      <div class="amort-subtitle" id="amort-modal-sub"></div>
    </div>
    <button class="btn-close" style="position:static;" onclick="closeAmort()">&#10005;</button>
  </div>
  <div class="amort-tabs">
    <button class="amort-tab active" onclick="switchAmortTab('schedule',this)">üìÖ Schedule</button>
    <button class="amort-tab" onclick="switchAmortTab('scenarios',this)">‚ö° Scenarios</button>
  </div>
  <div class="amort-body" id="amort-body"></div>
</div>

<!-- ADD/EDIT ACCOUNT MODAL -->
<div class="modal-overlay" id="account-modal">
  <div class="modal" style="position:relative;">
    <button class="btn-close" onclick="closeAccountModal()">&#10005;</button>
    <div class="modal-title" id="account-modal-title">Add Account</div>
    <input type="hidden" id="account-edit-id" value="" />
    <div class="form-group">
      <label class="form-label">Account Name</label>
      <input class="form-input" id="acct-name" placeholder="e.g. Home Mortgage, Toyota Camry..." />
    </div>
    <div class="form-group">
      <label class="form-label">Account Type</label>
      <select class="form-select" id="acct-type">
        <option value="mortgage">üè† Mortgage</option>
        <option value="car">üöó Car Loan</option>
        <option value="student">üìö Student Loan</option>
        <option value="credit">üí≥ Credit Card</option>
        <option value="personal">üíµ Personal Loan</option>
        <option value="other">üì¶ Other</option>
      </select>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      <div class="form-group"><label class="form-label">Current Balance ($)</label><input class="form-input" id="acct-balance" type="number" min="0" step="0.01" placeholder="250000" oninput="calcAccountPreview()" /></div>
      <div class="form-group"><label class="form-label">Interest Rate (% APR)</label><input class="form-input" id="acct-rate" type="number" min="0" step="0.01" placeholder="6.5" oninput="calcAccountPreview()" /></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      <div class="form-group"><label class="form-label">Monthly Payment ($)</label><input class="form-input" id="acct-payment" type="number" min="0" step="0.01" placeholder="1500" oninput="calcAccountPreview()" /></div>
      <div class="form-group"><label class="form-label">Original Balance ($)</label><input class="form-input" id="acct-original" type="number" min="0" step="0.01" placeholder="300000" /></div>
    </div>
    <div class="form-group"><label class="form-label">Start Date</label><input class="form-input" id="acct-start" type="date" /></div>
    <!-- Live preview -->
    <div id="acct-preview" style="display:none;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:14px;">
      <div style="font-size:0.72rem;color:var(--gold);letter-spacing:1px;text-transform:uppercase;font-weight:600;margin-bottom:10px;">Payoff Preview</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
        <div style="background:var(--surface2);border-radius:10px;padding:10px;text-align:center;">
          <div style="font-size:0.68rem;color:var(--text2);margin-bottom:4px;">PAYOFF DATE</div>
          <div id="preview-payoff" style="font-size:0.95rem;font-weight:700;color:var(--text);">‚Äî</div>
        </div>
        <div style="background:var(--surface2);border-radius:10px;padding:10px;text-align:center;">
          <div style="font-size:0.68rem;color:var(--text2);margin-bottom:4px;">TOTAL INTEREST</div>
          <div id="preview-interest" style="font-size:0.95rem;font-weight:700;color:var(--red);">‚Äî</div>
        </div>
      </div>
    </div>
    <button class="btn-primary" onclick="saveAccount()">Save Account</button>
  </div>
</div>

<script>
const BUILTIN_CATEGORIES = [
  { name: 'Food & Dining', icon: 'üçî', color: '#e05c6a', type: 'expense' },
  { name: 'Groceries', icon: 'üõí', color: '#c9a84c', type: 'expense' },
  { name: 'Transport', icon: 'üöå', color: '#5b7fde', type: 'expense' },
  { name: 'Shopping', icon: 'üõçÔ∏è', color: '#8a6de0', type: 'expense' },
  { name: 'Bills & Utilities', icon: 'üí°', color: '#e07c3a', type: 'expense' },
  { name: 'Health', icon: '‚ù§Ô∏è', color: '#e05c6a', type: 'expense' },
  { name: 'Entertainment', icon: 'üé¨', color: '#4caf82', type: 'expense' },
  { name: 'Travel', icon: '‚úàÔ∏è', color: '#5b7fde', type: 'expense' },
  { name: 'Subscriptions', icon: 'üì±', color: '#8a6de0', type: 'expense' },
  { name: 'Other Expense', icon: 'üì¶', color: '#8892a4', type: 'expense' },
  { name: 'Salary', icon: 'üíº', color: '#4caf82', type: 'income' },
  { name: 'Freelance', icon: 'üíª', color: '#c9a84c', type: 'income' },
  { name: 'Investment', icon: 'üìà', color: '#5b7fde', type: 'income' },
  { name: 'Refund', icon: '‚Ü©Ô∏è', color: '#4caf82', type: 'income' },
  { name: 'Other Income', icon: 'üí∞', color: '#8892a4', type: 'income' },
];
// Kept for backward compat with CSV import AI prompt
const CATEGORIES = BUILTIN_CATEGORIES;
function getAllCategories() { return [...BUILTIN_CATEGORIES, ...(state.customCategories||[])]; }
const CAT_NAMES = CATEGORIES.map(c => c.name);

let state = { transactions: [], budgets: {}, goals: [], customCategories: [], accounts: [] };

// ‚îÄ‚îÄ Export / Import ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportData() {
  const json = JSON.stringify(state, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const date = new Date().toISOString().split('T')[0];
  a.href = url;
  a.download = `vault-backup-${date}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importData(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const loaded = JSON.parse(e.target.result);
      if (!loaded.transactions) throw new Error('Invalid file');
      if (!confirm(`Load this backup?\n\nThis will replace your current data with:\n‚Ä¢ ${loaded.transactions.length} transactions\n‚Ä¢ ${(loaded.goals||[]).length} goals\n‚Ä¢ ${Object.keys(loaded.budgets||{}).length} budgets\n‚Ä¢ ${(loaded.accounts||[]).length} accounts`)) return;
      state = loaded;
      save();
      renderAll();
      alert('‚úÖ Data loaded successfully!');
    } catch(err) {
      alert('‚ùå Invalid backup file. Please choose a Vault backup JSON.');
    }
  };
  reader.readAsText(file);
  input.value = ''; // reset so same file can be loaded again
}

function load() { try { const s = localStorage.getItem('vault_state'); if (s) state = JSON.parse(s); } catch(e) {} }
function save() { localStorage.setItem('vault_state', JSON.stringify(state)); }
load();

let viewYear = new Date().getFullYear(), viewMonth = new Date().getMonth();
function changeMonth(d) { viewMonth += d; if (viewMonth > 11) { viewMonth = 0; viewYear++; } if (viewMonth < 0) { viewMonth = 11; viewYear--; } renderAll(); }
function getMonthLabel() { return new Date(viewYear, viewMonth, 1).toLocaleString('default', { month: 'long', year: 'numeric' }); }
function getCurrentTx() { return state.transactions.filter(t => { const d = new Date(t.date); return d.getFullYear() === viewYear && d.getMonth() === viewMonth; }); }

let currentTab = 'dashboard';
function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('sec-'+tab).classList.add('active');
  const tabs = ['dashboard','transactions','budget','goals','accounts'];
  document.querySelectorAll('.tab')[tabs.indexOf(tab)].classList.add('active');
  renderAll();
}

let txType = 'expense', splitMode = false;
function openAddTx() {
  splitMode = false;
  setType('expense');
  document.getElementById('tx-edit-id').value = '';
  document.getElementById('tx-modal-title').textContent = 'Add Transaction';
  document.getElementById('tx-name').value='';
  document.getElementById('tx-amount').value='';
  document.getElementById('tx-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('tx-notes').value='';
  populateCatSelect('tx-category',txType);
  document.getElementById('split-sw').classList.remove('on');
  document.getElementById('split-section').classList.remove('visible');
  document.getElementById('single-cat-group').style.display='';
  document.getElementById('split-rows').innerHTML='';
  document.getElementById('tx-modal').classList.add('open');
}
function openEditTx(id) {
  const t = state.transactions.find(tx=>tx.id===id);
  if (!t) return;
  splitMode = false;
  document.getElementById('tx-edit-id').value = id;
  document.getElementById('tx-modal-title').textContent = 'Edit Transaction';
  document.getElementById('split-sw').classList.remove('on');
  document.getElementById('split-section').classList.remove('visible');
  document.getElementById('split-rows').innerHTML='';
  document.getElementById('single-cat-group').style.display='';
  setType(t.type);
  document.getElementById('tx-name').value = t.name;
  document.getElementById('tx-amount').value = t.amount;
  document.getElementById('tx-date').value = t.date;
  document.getElementById('tx-notes').value = t.notes || '';
  populateCatSelect('tx-category', t.type);
  document.getElementById('tx-category').value = t.category;
  document.getElementById('tx-modal').classList.add('open');
}
function closeTxModal() { document.getElementById('tx-modal').classList.remove('open'); }
function setType(type) {
  txType=type;
  document.getElementById('btn-expense').classList.toggle('active',type==='expense');
  document.getElementById('btn-income').classList.toggle('active',type==='income');
  populateCatSelect('tx-category',type);
  document.querySelectorAll('.split-cat-sel').forEach(sel => {
    const cur = sel.value;
    sel.innerHTML = getAllCategories().filter(c=>c.type===type).map(c=>`<option value="${c.name}" ${c.name===cur?'selected':''}>${c.icon} ${c.name}</option>`).join('');
  });
}
function toggleSplit() {
  splitMode = !splitMode;
  document.getElementById('split-sw').classList.toggle('on', splitMode);
  document.getElementById('split-section').classList.toggle('visible', splitMode);
  document.getElementById('single-cat-group').style.display = splitMode ? 'none' : '';
  if (splitMode && document.getElementById('split-rows').children.length === 0) { addSplitRow(); addSplitRow(); }
  updateSplitRemaining();
}
function addSplitRow() {
  const id = 'sr'+(Date.now()+Math.floor(Math.random()*10000));
  const cats = getAllCategories().filter(c=>c.type===txType);
  const row = document.createElement('div');
  row.className = 'split-row';
  row.id = id;
  row.innerHTML = `<select class="split-cat-sel">${cats.map(c=>`<option value="${c.name}">${c.icon} ${c.name}</option>`).join('')}</select><input type="number" class="split-amt" placeholder="0.00" min="0" step="0.01" oninput="updateSplitRemaining()" /><button class="split-del" onclick="document.getElementById('${id}').remove();updateSplitRemaining()">‚úï</button>`;
  document.getElementById('split-rows').appendChild(row);
}
function updateSplitRemaining() {
  if (!splitMode) return;
  const total = parseFloat(document.getElementById('tx-amount').value) || 0;
  const allocated = Array.from(document.querySelectorAll('.split-amt')).reduce((s,i)=>s+(parseFloat(i.value)||0),0);
  const rem = total - allocated;
  const el = document.getElementById('split-remaining');
  if (total === 0) { el.className='split-remaining under'; el.textContent='Enter total amount above'; return; }
  if (Math.abs(rem) < 0.01) { el.className='split-remaining ok'; el.textContent='\u2713 Fully allocated'; }
  else if (rem > 0) { el.className='split-remaining under'; el.textContent=`$${rem.toFixed(2)} remaining to allocate`; }
  else { el.className='split-remaining over'; el.textContent=`Over by $${Math.abs(rem).toFixed(2)}`; }
}
function populateCatSelect(id, type) { document.getElementById(id).innerHTML = getAllCategories().filter(c=>!type||c.type===type).map(c=>`<option value="${c.name}">${c.icon} ${c.name}</option>`).join(''); }
function saveTx() {
  const name=document.getElementById('tx-name').value.trim();
  const amount=parseFloat(document.getElementById('tx-amount').value);
  const date=document.getElementById('tx-date').value;
  const notes=document.getElementById('tx-notes').value.trim();
  if (!name||!amount||!date) return alert('Please fill all fields');
  const editId = document.getElementById('tx-edit-id').value;
  if (splitMode) {
    const rows = Array.from(document.getElementById('split-rows').children);
    if (rows.length === 0) return alert('Add at least one split row');
    const splits = rows.map(r=>({ cat: r.querySelector('.split-cat-sel').value, amt: parseFloat(r.querySelector('.split-amt').value)||0 }));
    const total = splits.reduce((s,r)=>s+r.amt,0);
    if (Math.abs(total - amount) > 0.01) return alert(`Split amounts ($${total.toFixed(2)}) must equal total ($${amount.toFixed(2)})`);
    const grp = Date.now();
    splits.forEach((s,i) => {
      state.transactions.unshift({id:grp+i, name, amount:s.amt, category:s.cat, type:txType, date, notes, splitGroup:grp});
    });
  } else {
    const cat=document.getElementById('tx-category').value;
    if (editId) {
      const idx = state.transactions.findIndex(t=>t.id==editId);
      if (idx>=0) state.transactions[idx] = { ...state.transactions[idx], name, amount, category:cat, type:txType, date, notes };
    } else {
      state.transactions.unshift({id:Date.now(), name, amount, category:cat, type:txType, date, notes});
    }
  }
  save(); closeTxModal(); renderAll();
}

function openAddBudget() { populateCatSelect('budget-cat','expense'); document.getElementById('budget-limit').value=''; document.getElementById('budget-modal').classList.add('open'); }
function closeBudgetModal() { document.getElementById('budget-modal').classList.remove('open'); }
function saveBudget() { const cat=document.getElementById('budget-cat').value, limit=parseFloat(document.getElementById('budget-limit').value); if(!limit) return alert('Enter a limit'); state.budgets[cat]=limit; save(); closeBudgetModal(); renderAll(); }

function openAddGoal() { document.getElementById('goal-name').value=''; document.getElementById('goal-target').value=''; document.getElementById('goal-modal').classList.add('open'); }
function closeGoalModal() { document.getElementById('goal-modal').classList.remove('open'); }
function saveGoal() { const name=document.getElementById('goal-name').value.trim(), target=parseFloat(document.getElementById('goal-target').value), icon=document.getElementById('goal-icon').value; if(!name||!target) return alert('Fill all fields'); state.goals.push({id:Date.now(),name,target,saved:0,icon}); save(); closeGoalModal(); renderAll(); }

function fmt(n) { return '$'+Math.abs(n).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function fmtDate(s) { return new Date(s+'T00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'}); }
function getCat(name) { return getAllCategories().find(c=>c.name===name)||{icon:'üí∞',color:'#8892a4'}; }
function pctColor(p) { return p>=100?'#e05c6a':p>=80?'#e07c3a':'#4caf82'; }
function escHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function renderAll() {
  document.getElementById('currentMonth').textContent = getMonthLabel();
  document.getElementById('dash-sub').textContent = getMonthLabel();
  renderDashboard(); renderTransactions(); renderBudget(); renderGoals(); renderAccounts();
}

let monthChart = null;
function renderDashboard() {
  const txs = getCurrentTx();
  const income = txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const expense = txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const starting = state.startingBalance || 0;
  const net = starting + income - expense;
  document.getElementById('total-income').textContent = fmt(income);
  document.getElementById('total-expense').textContent = fmt(expense);
  const nb = document.getElementById('net-balance');
  nb.textContent = (net<0?'-':'')+fmt(Math.abs(net));
  nb.style.color = net<0?'var(--red)':'var(--green)';
  document.getElementById('recent-tx').innerHTML = txs.slice(0,5).map(txHTML).join('') || '<div class="empty"><div class="empty-icon">üí≥</div><p>No transactions this month</p></div>';
  const wI=[0,0,0,0], wE=[0,0,0,0];
  txs.forEach(t=>{ const w=Math.min(Math.floor((new Date(t.date+'T00:00').getDate()-1)/7),3); t.type==='income'?wI[w]+=t.amount:wE[w]+=t.amount; });
  const ctx=document.getElementById('monthChart').getContext('2d');
  if(monthChart) monthChart.destroy();
  monthChart = new Chart(ctx,{type:'bar',data:{labels:['Week 1','Week 2','Week 3','Week 4'],datasets:[{label:'Income',data:wI,backgroundColor:'rgba(76,175,130,0.7)',borderRadius:6},{label:'Expenses',data:wE,backgroundColor:'rgba(224,92,106,0.7)',borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#8892a4',font:{family:'DM Sans'}}}},scales:{x:{grid:{color:'#252b3a'},ticks:{color:'#8892a4'}},y:{grid:{color:'#252b3a'},ticks:{color:'#8892a4',callback:v=>'$'+v}}}}});
}

function startEditNetBalance() {
  const edit = document.getElementById('net-balance-edit');
  if (edit.style.display !== 'none') { cancelEditNetBalance(); return; }
  document.getElementById('starting-balance-input').value = state.startingBalance || '';
  edit.style.display = 'block';
  document.getElementById('starting-balance-input').focus();
  document.getElementById('starting-balance-input').select();
}
function cancelEditNetBalance() {
  document.getElementById('net-balance-edit').style.display = 'none';
}
function saveStartingBalance() {
  const val = parseFloat(document.getElementById('starting-balance-input').value);
  state.startingBalance = isNaN(val) ? 0 : val;
  save();
  cancelEditNetBalance();
  renderDashboard();
}

let selectMode = false;
const selectedTxIds = new Set();

function toggleSelectMode() {
  selectMode = !selectMode;
  selectedTxIds.clear();
  const bar = document.getElementById('multi-delete-bar');
  const btn = document.getElementById('select-mode-btn');
  bar.style.display = selectMode ? 'flex' : 'none';
  btn.textContent = selectMode ? '‚úï Cancel' : '‚òë Select';
  btn.style.color = selectMode ? 'var(--red)' : '';
  renderTransactions();
}

function toggleTxSelect(id) {
  if (selectedTxIds.has(id)) selectedTxIds.delete(id);
  else selectedTxIds.add(id);
  // Update just this row visually
  const row = document.getElementById('txrow-'+id);
  const cb = document.getElementById('txcb-'+id);
  if (row) row.classList.toggle('selected', selectedTxIds.has(id));
  if (cb) cb.classList.toggle('checked', selectedTxIds.has(id));
  document.getElementById('select-count-label').textContent = `${selectedTxIds.size} selected`;
}

function selectAllTx() {
  const visible = getFilteredTx();
  const allSelected = visible.every(t => selectedTxIds.has(t.id));
  if (allSelected) { visible.forEach(t => selectedTxIds.delete(t.id)); }
  else { visible.forEach(t => selectedTxIds.add(t.id)); }
  document.getElementById('select-count-label').textContent = `${selectedTxIds.size} selected`;
  renderTransactions();
}

function deleteSelectedTx() {
  if (!selectedTxIds.size) return;
  if (!confirm(`Delete ${selectedTxIds.size} transaction${selectedTxIds.size>1?'s':''}?`)) return;
  state.transactions = state.transactions.filter(t => !selectedTxIds.has(t.id));
  selectedTxIds.clear();
  save(); renderAll();
  document.getElementById('select-count-label').textContent = '0 selected';
}

function txHTML(t) {
  const cat = getCat(t.category);
  if (selectMode) {
    const checked = selectedTxIds.has(t.id);
    return `<div class="tx-item${checked?' selected':''}" id="txrow-${t.id}" onclick="toggleTxSelect(${t.id})">
      <div class="tx-checkbox${checked?' checked':''}" id="txcb-${t.id}"></div>
      <div class="tx-icon ${t.type}">${cat.icon}</div>
      <div class="tx-info">
        <div class="tx-name">${escHtml(t.name)}</div>
        <div class="tx-cat">${t.category}${t.notes?` ¬∑ <span style="color:var(--gold);font-style:italic;">üìù ${escHtml(t.notes.substring(0,40))}${t.notes.length>40?'‚Ä¶':''}</span>`:''}</div>
      </div>
      <div class="tx-right">
        <div class="tx-amount ${t.type}">${t.type==='income'?'+':'-'}${fmt(t.amount)}</div>
        <div class="tx-date">${fmtDate(t.date)}</div>
      </div>
    </div>`;
  }
  return `<div class="tx-item" onclick="openEditTx(${t.id})">
    <div class="tx-icon ${t.type}">${cat.icon}</div>
    <div class="tx-info">
      <div class="tx-name">${escHtml(t.name)}</div>
      <div class="tx-cat">${t.category}${t.notes?` ¬∑ <span style="color:var(--gold);font-style:italic;">üìù ${escHtml(t.notes.substring(0,40))}${t.notes.length>40?'‚Ä¶':''}</span>`:''}</div>
    </div>
    <div class="tx-right">
      <div class="tx-amount ${t.type}">${t.type==='income'?'+':'-'}${fmt(t.amount)}</div>
      <div class="tx-date">${fmtDate(t.date)}</div>
    </div>
    <button class="tx-menu-btn" onclick="toggleTxMenu(event,${t.id})">‚ãÆ</button>
    <div class="tx-popup" id="txpop-${t.id}">
      <div class="tx-popup-item" onclick="event.stopPropagation();closeAllTxMenus();openEditTx(${t.id})">‚úèÔ∏è Edit</div>
      <div class="tx-popup-item danger" onclick="event.stopPropagation();closeAllTxMenus();deleteTx(${t.id})">üóë Delete</div>
    </div>
  </div>`;
}
function toggleTxMenu(e, id) {
  e.stopPropagation();
  const pop = document.getElementById('txpop-'+id);
  const wasOpen = pop.classList.contains('open');
  closeAllTxMenus();
  if (!wasOpen) pop.classList.add('open');
}
function closeAllTxMenus() {
  document.querySelectorAll('.tx-popup.open').forEach(p=>p.classList.remove('open'));
}
document.addEventListener('click', closeAllTxMenus);
function deleteTx(id) { if(!confirm('Delete this transaction?')) return; state.transactions=state.transactions.filter(t=>t.id!==id); save(); renderAll(); }

function reCleanAllDescriptions() {
  if (!confirm(`Re-clean descriptions for all ${state.transactions.length} transactions?\n\nThis strips bank noise like "Withdrawal, " and "Debit Card" to show just the merchant name. You can edit any individual transaction to fix it manually.`)) return;
  state.transactions = state.transactions.map(t => ({ ...t, name: cleanDescription(t.name) }));
  save(); renderAll();
}

let txFilter='all';
function getFilteredTx() {
  return state.transactions.filter(t=>txFilter==='all'||t.type===txFilter);
}
function renderTransactions() {
  document.getElementById('tx-filter-chips').innerHTML=['all','income','expense'].map((f,i)=>`<span class="chip ${txFilter===f?'active':''}" onclick="setTxFilter('${f}')">${['All','Income','Expense'][i]}</span>`).join('');
  const txs = getFilteredTx();
  const list=document.getElementById('all-tx-list');
  if(!txs.length){list.innerHTML='<div class="empty"><div class="empty-icon">üí≥</div><p>No transactions yet.<br>Import a CSV or tap + to add!</p></div>';return;}
  const groups={};
  txs.forEach(t=>{const k=t.date.substring(0,7);if(!groups[k])groups[k]=[];groups[k].push(t);});
  list.innerHTML=Object.keys(groups).sort((a,b)=>b.localeCompare(a)).map(k=>{const[y,m]=k.split('-');return`<div style="font-size:0.75rem;color:var(--text2);letter-spacing:1px;text-transform:uppercase;padding:8px 0 4px;font-weight:600;">${new Date(+y,+m-1,1).toLocaleString('default',{month:'long',year:'numeric'})}</div>`+groups[k].map(txHTML).join('');}).join('');
}
function setTxFilter(f){txFilter=f;renderTransactions();}

let budgetChart=null;
function renderBudget() {
  const txs=getCurrentTx().filter(t=>t.type==='expense'), spending={};
  txs.forEach(t=>{spending[t.category]=(spending[t.category]||0)+t.amount;});
  const allCats=Object.keys({...state.budgets,...spending});
  document.getElementById('budget-list').innerHTML=!allCats.length?`<div class="card"><div class="empty"><div class="empty-icon">üéØ</div><p>No budgets yet.<br>Tap + to add limits.</p></div></div>`:allCats.map(cat=>{const c_=getCat(cat),spent=spending[cat]||0,limit=state.budgets[cat],pct=limit?Math.min((spent/limit)*100,100):null,over=limit?(spent/limit)*100:null;return`<div class="card"><div class="budget-item"><div class="budget-header"><div class="budget-name"><div class="cat-dot" style="background:${c_.color}"></div>${c_.icon} ${cat}</div><div class="budget-amounts">${fmt(spent)}${limit?' / '+fmt(limit):''}</div></div>${limit?`<div class="progress-bar"><div class="progress-fill" style="width:${pct}%;background:${pctColor(over)}"></div></div><div class="budget-pct">${Math.round(over)}% used${over>100?' ‚ö†Ô∏è':''}</div>`:`<div style="font-size:0.8rem;color:var(--text2);margin-top:4px;">No limit ‚Äî <span class="add-link" onclick="setBudgetFor('${cat}')">Set limit</span></div>`}</div></div>`;}).join('');
  const labels=Object.keys(spending),data=labels.map(l=>spending[l]),colors=labels.map(l=>getCat(l).color);
  const ctx=document.getElementById('budgetChart').getContext('2d');
  if(budgetChart) budgetChart.destroy();
  document.getElementById('budgetChart').style.display=labels.length?'block':'none';
  if(labels.length) budgetChart=new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data,backgroundColor:colors,borderWidth:2,borderColor:'#161922'}]},options:{responsive:true,maintainAspectRatio:false,cutout:'65%',plugins:{legend:{position:'bottom',labels:{color:'#8892a4',font:{family:'DM Sans',size:11},padding:10,boxWidth:12}}}}});
}
function setBudgetFor(cat){document.getElementById('budget-cat').innerHTML=`<option value="${cat}">${getCat(cat).icon} ${cat}</option>`;document.getElementById('budget-limit').value='';document.getElementById('budget-modal').classList.add('open');}

function renderGoals() {
  const list=document.getElementById('goals-list');
  if(!state.goals.length){list.innerHTML='<div class="card"><div class="empty"><div class="empty-icon">‚≠ê</div><p>No goals yet.<br>Tap + to create one!</p></div></div>';return;}
  list.innerHTML=state.goals.map((g,i)=>{const pct=Math.min((g.saved/g.target)*100,100);return`<div class="card"><div class="goal-item" style="padding:0;border:none;"><div class="goal-header"><div class="goal-name">${g.icon} ${escHtml(g.name)}</div><div style="display:flex;align-items:center;gap:10px;"><span class="goal-pct">${Math.round(pct)}%</span><span style="color:var(--text2);cursor:pointer;" onclick="deleteGoal(${i})">üóë</span></div></div><div class="progress-bar" style="height:8px;"><div class="progress-fill" style="width:${pct}%;background:var(--gold);"></div></div><div class="goal-amounts"><span class="saved">${fmt(g.saved)} saved</span><span>${fmt(g.target)} goal</span></div>${g.target>g.saved?`<div class="goal-contribute"><input type="number" id="contrib-${i}" placeholder="Add amount..." min="0" step="1" /><button class="btn-sm" onclick="contribute(${i})">Add</button></div>`:`<div style="text-align:center;color:var(--green);font-weight:600;margin-top:8px;">üéâ Goal Reached!</div>`}</div></div>`;}).join('');
}
function contribute(i){const v=parseFloat(document.getElementById('contrib-'+i).value);if(!v||v<=0)return;state.goals[i].saved=Math.min(state.goals[i].saved+v,state.goals[i].target);save();renderGoals();}
function deleteGoal(i){if(!confirm('Delete this goal?'))return;state.goals.splice(i,1);save();renderGoals();}

// ==================== CSV IMPORT ====================
let csvRows=[], csvHeaders=[], colMap={}, parsedTx=[];

const PRESETS = {
  chase:   {date:'Transaction Date',desc:'Description',amount:'Amount',format:'negative'},
  bofa:    {date:'Date',desc:'Description',amount:'Amount',format:'negative'},
  wells:   {date:'Date',desc:'Description',amount:'Amount',format:'negative'},
  capital: {date:'Transaction Date',desc:'Transaction Description',amount:'Debit',format:'negative'},
  lmcu:    {date:'Posting Date',desc:'Description',amount:'Amount',format:'negative'},
  generic: {date:'Date',desc:'Description',amount:'Amount',format:'negative'}
};

function openImport(){
  csvRows=[];csvHeaders=[];colMap={};parsedTx=[];
  document.querySelectorAll('.bank-chip').forEach(c=>c.classList.remove('active'));
  goToStep(0);
  document.getElementById('import-modal').classList.add('open');
}
function closeImport(){document.getElementById('import-modal').classList.remove('open');}

function applyPreset(el, key) {
  document.querySelectorAll('.bank-chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  // Show LMCU tip
  const tipEl = document.getElementById('bank-tip');
  if (key === 'lmcu') {
    tipEl.innerHTML = `<div style="margin-top:12px;padding:10px 14px;background:rgba(201,168,76,0.08);border:1px solid rgba(201,168,76,0.25);border-radius:10px;font-size:0.8rem;color:var(--text2);line-height:1.5;">
      <b style="color:var(--gold);">üìã How to export from LMCU:</b><br>
      Log in ‚Üí click your account ‚Üí <b>Transaction History</b> ‚Üí set your date range ‚Üí click <b>Export</b> and choose <b>CSV</b>.
      If your CSV uses <b>Debit/Credit</b> columns instead of Amount, the auto-detector will catch it ‚Äî or adjust in Step 2.
    </div>`;
  } else {
    tipEl.innerHTML = '';
  }
  if(csvHeaders.length){const p=PRESETS[key];colMap.date=csvHeaders.find(h=>h.toLowerCase().includes(p.date.toLowerCase()))||colMap.date;colMap.desc=csvHeaders.find(h=>h.toLowerCase().includes(p.desc.toLowerCase()))||colMap.desc;colMap.amount=csvHeaders.find(h=>h.toLowerCase().includes(p.amount.toLowerCase()))||colMap.amount;colMap.format=p.format;buildColMapUI();updateColPreview();}
}

function goToStep(n){
  for(let i=0;i<4;i++){
    const el=document.getElementById('import-step-'+i);
    if(el)el.style.display=i===n?'block':'none';
    const ind=document.getElementById('step-ind-'+i);
    if(ind){ind.classList.remove('active','done');if(i<n)ind.classList.add('done');else if(i===n)ind.classList.add('active');}
  }
}

const dz=document.getElementById('drop-zone');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('dragging');});
dz.addEventListener('dragleave',()=>dz.classList.remove('dragging'));
dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('dragging');if(e.dataTransfer.files[0])handleFileSelect(e.dataTransfer.files[0]);});

function handleFileSelect(file){if(!file)return;const r=new FileReader();r.onload=e=>parseCSV(e.target.result);r.readAsText(file);}

function parseCSVLine(line) {
  // Proper RFC 4180 CSV parser - handles quoted fields, embedded commas, escaped quotes
  const result = [];
  let i = 0;
  while (i <= line.length) {
    if (line[i] === '"') {
      // Quoted field
      let val = '';
      i++; // skip opening quote
      while (i < line.length) {
        if (line[i] === '"' && line[i+1] === '"') { val += '"'; i += 2; }
        else if (line[i] === '"') { i++; break; }
        else { val += line[i++]; }
      }
      result.push(val.trim());
      if (line[i] === ',') i++; // skip comma
    } else {
      // Unquoted field
      const end = line.indexOf(',', i);
      if (end === -1) {
        result.push(line.slice(i).trim());
        break;
      } else {
        result.push(line.slice(i, end).trim());
        i = end + 1;
      }
    }
  }
  return result;
}

function parseCSV(text){
  // Normalize line endings, remove BOM if present
  text = text.replace(/^\uFEFF/, '').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
  const lines = text.split('\n');
  // Find first non-empty line as header
  const headerIdx = lines.findIndex(l => l.trim());
  if (headerIdx === -1 || lines.length < headerIdx + 2) return alert('CSV appears empty.');
  csvHeaders = parseCSVLine(lines[headerIdx]);
  csvRows = lines.slice(headerIdx + 1)
    .filter(l => l.trim())
    .map(l => parseCSVLine(l))
    .filter(r => r.some(c => c));
  // Auto-detect columns
  colMap.date = csvHeaders.find(h=>/date|time/i.test(h)) || csvHeaders[0];
  colMap.desc = csvHeaders.find(h=>/desc|narr|memo|detail|name|merchant|payee/i.test(h)) || csvHeaders[1];
  colMap.amount = csvHeaders.find(h=>/^amount$|^sum$|debit/i.test(h)) || csvHeaders.find(h=>/amount|sum/i.test(h)) || csvHeaders[2];
  colMap.credit = csvHeaders.find(h=>/^credit$/i.test(h)) || '';
  colMap.format = 'negative';
  buildColMapUI();
  goToStep(1);
  updateColPreview();
}

function makeColSelect(field, label){
  return`<div class="form-group"><label class="form-label">${label}</label><select class="form-select" id="map-${field}" onchange="colMap['${field}']=this.value;updateColPreview()">${csvHeaders.map(h=>`<option value="${escHtml(h)}" ${colMap[field]===h?'selected':''}>${escHtml(h)}</option>`).join('')}</select></div>`;
}
function buildColMapUI(){
  const noneOption = `<option value="">‚Äî None ‚Äî</option>`;
  const creditOpts = noneOption + csvHeaders.map(h=>`<option value="${escHtml(h)}" ${colMap.credit===h?'selected':''}>${escHtml(h)}</option>`).join('');
  document.getElementById('col-map-grid').innerHTML =
    makeColSelect('date','Date Column') +
    makeColSelect('desc','Description Column') +
    makeColSelect('amount','Debit/Amount Column') +
    `<div class="form-group"><label class="form-label">Credit Column <span style="color:var(--text2);font-weight:400">(optional)</span></label><select class="form-select" id="map-credit" onchange="colMap['credit']=this.value;updateColPreview()">${creditOpts}</select></div>`;
  document.getElementById('amount-format').value=colMap.format||'negative';
}
function updateColPreview(){
  const di=csvHeaders.indexOf(colMap.date),ni=csvHeaders.indexOf(colMap.desc),ai=csvHeaders.indexOf(colMap.amount),ci=colMap.credit?csvHeaders.indexOf(colMap.credit):-1;
  document.getElementById('col-preview').innerHTML=csvRows.slice(0,3).map(r=>{
    const rawDate = r[di]||'';
    const parsed = parseDate(rawDate);
    const dateDisplay = parsed
      ? `üìÖ ${escHtml(rawDate)} <span style="color:var(--green);font-size:0.72rem">‚Üí ${parsed}</span>`
      : `üìÖ <span style="color:var(--red)">${escHtml(rawDate)||'(empty)'} ‚ö†Ô∏è unreadable</span>`;
    return `<div style="margin-bottom:4px;padding:5px 8px;background:var(--surface2);border-radius:6px;font-size:0.78rem;">${dateDisplay} &nbsp; üìù ${escHtml((r[ni]||'').substring(0,20))} &nbsp; üí≤ ${escHtml(r[ai]||'')}${ci>=0?` &nbsp; üíö ${escHtml(r[ci]||'')}`:''}</div>`;
  }).join('');
}

function cleanDescription(raw) {
  let s = raw.trim();

  // Remove HTML tags including truncated ones
  s = s.replace(/<\/?[A-Za-z][^>]*>?/g, ' ').replace(/&\w+;/g, ' ');

  // Strip everything from ", Type:" or " Type:" onward ‚Äî bank metadata
  s = s.replace(/[,\s]+Type\s*:.*/i, '');

  // Strip "Id:", "Seq:", "Trace:", "Ref:", "Trn:" and everything after
  s = s.replace(/\s+(Id|Seq|Trace|Ref|Trn|Ccd|Ppd|Tel|Web)\s*:?.*/i, '');

  // Strip trailing " - XXXXXXXXX" reference codes (dash + alphanumeric)
  s = s.replace(/\s+-\s+[A-Z0-9]{6,}.*$/i, '');

  // Collapse whitespace
  s = s.replace(/\s{2,}/g, ' ').trim();

  // Remove reference/trace numbers
  s = s.replace(/\s*(#|Ref:?|ID:?|Seq:?|Trace:?)\s*\d+/gi, '');

  // Remove store/branch numbers like #247
  s = s.replace(/\s*#\d+/g, '');

  // Remove inline dates like 01/15 or 01/15/25
  s = s.replace(/\s+\d{1,2}\/\d{1,2}(\/\d{2,4})?/g, '');

  // Remove trailing state codes (MI, OH, IN, WI etc.)
  s = s.replace(/\s+[A-Z]{2}\s*$/g, '');

  // ‚îÄ‚îÄ Pattern: "Debit Card MERCHANT" ‚Äî merchant comes AFTER
  const debitCardAfter = s.match(/^Debit\s+Card\s+(.+)$/i);
  if (debitCardAfter && debitCardAfter[1].trim().length > 1) s = debitCardAfter[1].trim();

  // ‚îÄ‚îÄ Pattern: "MERCHANT Debit Card" ‚Äî strip suffix
  s = s.replace(/\s+(Debit\s+Card|Debit\s+Cr\w*|Credit\s+Card|Check\s+Card)\s*$/i, '');

  // ‚îÄ‚îÄ Pattern: "Withdrawal, MERCHANT"
  const withdrawalComma = s.match(/^Withdrawal[,\s]+(.+)$/i);
  if (withdrawalComma) s = withdrawalComma[1];

  // ‚îÄ‚îÄ Pattern: "Transfer To MERCHANT"
  const transferTo = s.match(/^Transfer\s+To\s+(.+)$/i);
  if (transferTo) s = transferTo[1];

  // ‚îÄ‚îÄ "Withdrawal Bill Payment" ‚Üí "Bill Payment"
  s = s.replace(/^Withdrawal\s+(Bill\s+Payment)/i, '$1');
  s = s.replace(/^Withdrawal\s+(Transfer)/i, '$1');

  // ‚îÄ‚îÄ Strip "DEPOSIT " prefix
  s = s.replace(/^DEPOSIT\s+/i, '');

  // ‚îÄ‚îÄ ACH/bank prefixes
  s = s.replace(/^(POS |ACH |DBT |CHK |DDA |EFT |TFR |PPD |CCD |WEB |TEL |ARC |PREAUTH\s+|ONLINE\s+|RECURRING\s+)/i, '');
  s = s.replace(/^(SQ \*|SP \*|PP \*|TST\*\s*|IN \*|FS \*)/i, '');

  // Remove trailing comma or punctuation
  s = s.replace(/[,\s]+$/, '').trim();

  if (!s || s.length < 2) s = raw.replace(/<\/?[A-Za-z][^>]*>?/g, '').replace(/\s{2,}/g, ' ').trim();

  // Title-case
  s = s.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());

  return s || raw.trim();
}

const INCOME_KEYWORDS = /\b(deposit|deposited|credit|payroll|direct dep|direct deposit|salary|wages|refund|interest paid|dividend|transfer in|cashback|cash back|reimburse|reimbursement|zelle in|venmo in|payment received|tax return|ach credit|incoming|wire in)\b/i;
const EXPENSE_KEYWORDS = /\b(purchase|payment|withdrawal|debit|charge|fee|pos |atm |check #|amazon|walmart|target|costco)\b/i;

function parseAmount(raw) {
  if (!raw || !raw.trim()) return NaN;
  let s = raw.trim();
  // Parentheses = negative e.g. (45.00) used by some banks
  const negative = s.startsWith('(') && s.endsWith(')');
  s = s.replace(/[()$¬£‚Ç¨¬•,\s]/g, '');
  const n = parseFloat(s);
  return negative ? -Math.abs(n) : n;
}

function parseDate(raw){
  if(!raw || !raw.trim()) return null;
  let s = raw.trim().replace(/['"]/g, '');

  // Already ISO: 2026-02-15
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

  // YYYYMMDD
  const m0 = s.match(/^(\d{4})(\d{2})(\d{2})$/);
  if(m0) return `${m0[1]}-${m0[2]}-${m0[3]}`;

  // MM/DD/YYYY or MM-DD-YYYY or MM.DD.YYYY
  const m1 = s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})$/);
  if(m1) return `${m1[3]}-${m1[1].padStart(2,'0')}-${m1[2].padStart(2,'0')}`;

  // MM/DD/YY
  const m2 = s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2})$/);
  if(m2) return `20${m2[3]}-${m2[1].padStart(2,'0')}-${m2[2].padStart(2,'0')}`;

  // Try native Date parse (handles "Feb 15, 2026" etc.) but avoid timezone issues
  const d = new Date(s);
  if(!isNaN(d.getTime())){
    // Use UTC to avoid off-by-one day from timezone
    const utc = new Date(d.getTime() + d.getTimezoneOffset() * 60000);
    return utc.toISOString().split('T')[0];
  }

  return null;
}

function goToStep2(){
  parsedTx = [];
  const di = csvHeaders.indexOf(colMap.date);
  const ni = csvHeaders.indexOf(colMap.desc);
  const ai = csvHeaders.indexOf(colMap.amount);
  const ci = colMap.credit ? csvHeaders.indexOf(colMap.credit) : -1;
  const today = new Date().toISOString().split('T')[0];

  // Diagnostic counters
  const fallbacks = { noDesc:0, badAmount:0, badDate:0 };

  csvRows.forEach((row) => {
    // Description ‚Äî fallback to "Unknown" rather than skipping
    const desc = (row[ni] || '').trim() || (() => { fallbacks.noDesc++; return 'Unknown'; })();

    let amount = 0, type = 'expense';

    if (ci >= 0 && colMap.credit) {
      const debit  = parseAmount(row[ai] || '');
      const credit = parseAmount(row[ci] || '');
      const dVal = isNaN(debit)  ? 0 : Math.abs(debit);
      const cVal = isNaN(credit) ? 0 : Math.abs(credit);
      if (cVal > 0) { amount = cVal; type = 'income'; }
      else          { amount = dVal; type = 'expense'; }
      if (isNaN(debit) && isNaN(credit)) fallbacks.badAmount++;
    } else {
      const rawAmt = (row[ai] || '').trim();
      const parsed = parseAmount(rawAmt);
      if (!rawAmt || isNaN(parsed)) {
        fallbacks.badAmount++;
        amount = 0;
        type = 'expense';
      } else {
        amount = parsed;
        if (colMap.format === 'positive') {
          type = INCOME_KEYWORDS.test(desc) ? 'income' : 'expense';
        } else if (colMap.format === 'flipped') {
          type = amount < 0 ? 'income' : 'expense';
        } else {
          type = amount < 0 ? 'expense' : 'income';
          if (type === 'income' && EXPENSE_KEYWORDS.test(desc) && !INCOME_KEYWORDS.test(desc)) type = 'expense';
          if (type === 'expense' && INCOME_KEYWORDS.test(desc)) type = 'income';
        }
      }
    }

    // Date ‚Äî fallback to today rather than skipping
    const rawDate = (row[di] || '').trim();
    const date = parseDate(rawDate) || (() => { fallbacks.badDate++; return today; })();

    const defaultCat = type === 'income' ? 'Other Income' : 'Other Expense';
    parsedTx.push({ id: Date.now() * 1000 + parsedTx.length, name: cleanDescription(desc), amount: Math.abs(amount), type, date, category: defaultCat });
  });

  // Show diagnostic
  const diagEl = document.getElementById('import-diag');
  if (diagEl) {
    const total = fallbacks.noDesc + fallbacks.badAmount + fallbacks.badDate;
    if (total > 0) {
      const reasons = [];
      if (fallbacks.noDesc)   reasons.push(`${fallbacks.noDesc} had no description (shown as "Unknown")`);
      if (fallbacks.badAmount)reasons.push(`${fallbacks.badAmount} had unreadable amounts (set to $0 ‚Äî edit after import)`);
      if (fallbacks.badDate)  reasons.push(`${fallbacks.badDate} had unreadable dates (set to today ‚Äî edit after import)`);
      diagEl.innerHTML = `<div style="background:rgba(201,168,76,0.08);border:1px solid rgba(201,168,76,0.25);border-radius:10px;padding:12px;margin-bottom:12px;font-size:0.8rem;">
        ‚ö†Ô∏è <strong>${parsedTx.length}/${csvRows.length} rows imported</strong> ‚Äî ${total} needed fallbacks:<br>
        <span style="color:var(--text2)">${reasons.join(' ¬∑ ')}</span>
      </div>`;
    } else {
      diagEl.innerHTML = `<div style="color:var(--green);font-size:0.8rem;margin-bottom:8px;">‚úì All ${parsedTx.length} rows imported cleanly</div>`;
    }
  }

  if (!parsedTx.length) return alert('No rows found. Check your column mapping.');
  goToStep(2);
  renderPreviewTable();
  runAI();
}

function renderPreviewTable(){
  document.getElementById('import-count').textContent=`${parsedTx.length} transactions found`;
  document.getElementById('preview-tbody').innerHTML=parsedTx.map((t,i)=>`<tr>
    <td>${fmtDate(t.date)}</td>
    <td style="max-width:110px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${escHtml(t.name)}">${escHtml(t.name.substring(0,20))}${t.name.length>20?'‚Ä¶':''}</td>
    <td class="tx-amount ${t.type}" style="white-space:nowrap;">${t.type==='income'?'+':'-'}${fmt(t.amount)}</td>
    <td><select id="cat-sel-${i}" onchange="parsedTx[${i}].category=this.value;const co=CATEGORIES.find(c=>c.name===this.value);if(co)parsedTx[${i}].type=co.type;">${CATEGORIES.map(c=>`<option value="${c.name}" ${t.category===c.name?'selected':''}>${c.icon} ${c.name}</option>`).join('')}</select></td>
  </tr>`).join('');
}

// API key helpers
// ‚îÄ‚îÄ JS Keyword Categorizer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CAT_RULES = [
  // Income
  { cat:'Salary',       type:'income',  rx:/\b(payroll|payrll|salary|wages|direct dep|direct deposit|gusto|adp|paychex|workday|corewell|leggett|employer)\b/i },
  { cat:'Freelance',    type:'income',  rx:/\b(freelance|upwork|fiverr|stripe|invoice|consulting|1099)\b/i },
  { cat:'Investment',   type:'income',  rx:/\b(dividend|interest|robinhood|fidelity|vanguard|schwab|etrade|coinbase|crypto)\b/i },
  { cat:'Refund',       type:'income',  rx:/\b(refund|return|cashback|cash back|credit adj|reversal|chargeback)\b/i },

  // Food & Dining
  { cat:'Food & Dining', type:'expense', rx:/\b(restaurant|cafe|coffee|starbucks|dunkin|mcdonald|burger|taco|pizza|subway|chipotle|panera|domino|doordash|grubhub|uber eats|chick.fil|wendy|kfc|applebee|olive garden|chili|denny|ihop|waffle|sushi|thai|chinese|mexican|diner|grill|bistro|eatery|steakhouse|barbeque|bbq|wing|noodle|panda|jersey mike|potbelly|culver|arby|sonic|dairy queen|five guys|shake shack|whitecasle|hardee|jack in the box|popeye|raising cane|wingstop|jimmy john|firehouse|toast|olo|resy|postmates|instacart eat)\b/i },

  // Groceries
  { cat:'Groceries', type:'expense', rx:/\b(meijer|kroger|walmart|target|costco|aldi|whole foods|trader joe|safeway|publix|wegman|heb|sprout|fresh market|food lion|giant|stop.?shop|save.?a.?lot|family dollar|dollar general|dollar tree|aldi|winco|market basket|jewel|vons|ralphs|smith.?food|harris teeter|winn.?dixie|sav.?a.?lot|super kmart|biggs|marten house)\b/i },

  // Transport
  { cat:'Transport', type:'expense', rx:/\b(gas station|shell|bp|exxon|mobil|chevron|marathon|sunoco|speedway|circle k|kwik trip|casey|wawa|pilot|loves|meijer gas|uber|lyft|taxi|transit|parking|toll|autozone|o.?reilly|advance auto|napa auto|jiffy lube|oil change|car wash|hertz|enterprise|avis|budget rent|turo)\b/i },

  // Bills & Utilities
  { cat:'Bills & Utilities', type:'expense', rx:/\b(electric|consumers energy|dte|at.?t|verizon|t.?mobile|sprint|comcast|xfinity|spectrum|dish|directv|hulu live|youtube tv|internet|utility|water bill|gas bill|insurance|progressive|geico|allstate|state farm|nationwide|liberty mutual|esurance|mortgage|rent|lease|hoa|dues|waste management|trash|sewage)\b/i },

  // Subscriptions
  { cat:'Subscriptions', type:'expense', rx:/\b(netflix|hulu|disney|spotify|apple music|amazon prime|prime video|youtube premium|hbo|peacock|paramount|crunchyroll|twitch|adobe|microsoft 365|office 365|dropbox|icloud|google one|playstation|xbox|nintendo|audible|kindle|patreon|onlyfans|masterclass|duolingo|headspace|calm|noom|weight watcher)\b/i },

  // Health
  { cat:'Health', type:'expense', rx:/\b(pharmacy|cvs|walgreen|rite aid|hospital|clinic|urgent care|doctor|dentist|optometrist|vision|medical|health|prescription|dr\.|dental|optum|humana|cigna|aetna|blue cross|anthem|unitedhealthcare|quest diagnostic|labcorp|planned parenthood)\b/i },

  // Entertainment
  { cat:'Entertainment', type:'expense', rx:/\b(cinema|theater|movie|amc|regal|cinemark|ticketmaster|stubhub|eventbrite|concert|bowling|arcade|dave.?buster|topgolf|minigolf|museum|zoo|aquarium|theme park|six flags|cedar point|disney park|universal|seaworld|escape room|paintball|laser tag|putt.?putt)\b/i },

  // Shopping
  { cat:'Shopping', type:'expense', rx:/\b(amazon|ebay|etsy|walmart\.com|best buy|apple store|ikea|home depot|lowe.?s|menard|ace hardware|bed bath|bath body|victoria secret|gap|old navy|h&m|zara|forever 21|tj.?maxx|marshalls|ross|burlington|nordstrom|macy|kohls|jcpenney|sears|dick.?s sporting|rei|sport|foot locker|nike|adidas|under armour|chewy|petco|petsmart|wayfair|overstock|wish\.com|shein|temu|aliexpress)\b/i },

  // Travel
  { cat:'Travel', type:'expense', rx:/\b(airline|delta|united|american air|southwest|jetblue|spirit air|frontier|allegiant|hotel|marriott|hilton|hyatt|ihg|holiday inn|best western|airbnb|vrbo|expedia|priceline|booking\.com|hotels\.com|kayak|trivago|carnival|royal caribbean|norwegian cruise|amtrak|greyhound|megabus|alamo)\b/i },
];

function jsCategorizeTx(name, type) {
  const allCats = getAllCategories();
  for (const rule of CAT_RULES) {
    if (rule.type !== type) continue;
    if (rule.rx.test(name)) {
      const cat = allCats.find(c => c.name === rule.cat);
      if (cat) return cat;
    }
  }
  return null;
}

function runAI(){
  const box = document.getElementById('ai-status-box');
  box.innerHTML = `<div class="ai-status"><div class="spinner"></div><div>Categorizing transactions‚Ä¶</div></div>`;

  // Small delay so spinner renders
  setTimeout(() => {
    const allCats = getAllCategories();
    let matched = 0;
    parsedTx.forEach(t => {
      const cat = jsCategorizeTx(t.name, t.type);
      if (cat) {
        t.category = cat.name;
        t.type = cat.type;
        matched++;
      }
    });
    const unmatched = parsedTx.length - matched;
    box.innerHTML = `<div class="ai-status ai-done">‚ö° Categorized ${matched} transactions automatically${unmatched > 0 ? ` ¬∑ ${unmatched} left as defaults` : ''} ‚Äî review below</div>`;
    renderPreviewTable();
  }, 50);
}

function confirmImport(){
  parsedTx.forEach((t,i)=>{const sel=document.getElementById('cat-sel-'+i);if(sel){t.category=sel.value;const co=CATEGORIES.find(c=>c.name===sel.value);if(co)t.type=co.type;}});
  const existing = new Set(state.transactions.map(t=>`${t.date}|${t.amount}|${t.type}`));
  const newTx = parsedTx.filter(t=>!existing.has(`${t.date}|${t.amount}|${t.type}`));
  const dupes = parsedTx.length - newTx.length;
  state.transactions=[...newTx,...state.transactions].sort((a,b)=>b.date.localeCompare(a.date));
  save();
  document.getElementById('import-done-msg').textContent=`${newTx.length} transactions imported successfully${dupes>0?`. ${dupes} duplicates skipped.`:''}`;
  goToStep(3);
  renderAll();
}

document.getElementById('tx-modal').addEventListener('click',e=>{if(e.target===e.currentTarget)closeTxModal();});
document.getElementById('budget-modal').addEventListener('click',e=>{if(e.target===e.currentTarget)closeBudgetModal();});
document.getElementById('goal-modal').addEventListener('click',e=>{if(e.target===e.currentTarget)closeGoalModal();});
document.getElementById('import-modal').addEventListener('click',e=>{if(e.target===e.currentTarget)closeImport();});
document.getElementById('cat-modal').addEventListener('click',e=>{if(e.target===e.currentTarget)closeCatManager();});
document.getElementById('account-modal').addEventListener('click',e=>{if(e.target===e.currentTarget)closeAccountModal();});

// ‚îÄ‚îÄ Accounts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ACCT_ICONS = { mortgage:'üè†', car:'üöó', student:'üìö', credit:'üí≥', personal:'üíµ', other:'üì¶' };
const ACCT_LABELS = { mortgage:'Mortgage', car:'Car Loan', student:'Student Loan', credit:'Credit Card', personal:'Personal Loan', other:'Other' };

// Build full month-by-month amortization schedule
// paymentOverrides: { 'YYYY-MM': amount } ‚Äî lets user record actual payments
function buildSchedule(balance, annualRate, defaultPayment, startDate, paymentOverrides={}) {
  const r = annualRate / 100 / 12;
  const rows = [];
  let bal = balance;
  let d = startDate ? new Date(startDate+'T00:00') : new Date();
  d.setDate(1);
  const today = new Date(); today.setDate(1);
  const maxMonths = 600; // safety cap 50 years

  for (let i = 0; i < maxMonths && bal > 0.005; i++) {
    const monthKey = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
    const interest = bal * r;
    const scheduledPrincipal = Math.max(0, defaultPayment - interest);
    const override = paymentOverrides[monthKey];
    const payment = override !== undefined ? override : defaultPayment;
    const actualInterest = r > 0 ? bal * r : 0;
    const principal = Math.min(bal, Math.max(0, payment - actualInterest));
    const endBal = Math.max(0, bal - principal);
    rows.push({
      monthKey,
      date: new Date(d),
      payment: payment,
      principal,
      interest: actualInterest,
      balance: endBal,
      isOverride: override !== undefined,
      isPast: d < today,
      isCurrentMonth: d.getFullYear()===today.getFullYear() && d.getMonth()===today.getMonth(),
      scheduledPayment: defaultPayment
    });
    bal = endBal;
    d = new Date(d); d.setMonth(d.getMonth()+1);
  }
  return rows;
}

function scheduleStats(rows) {
  const totalPaid = rows.reduce((s,r)=>s+r.payment,0);
  const totalInterest = rows.reduce((s,r)=>s+r.interest,0);
  const lastRow = rows[rows.length-1];
  return { totalPaid, totalInterest, payoffDate: lastRow ? lastRow.date : null, months: rows.length };
}

function calcPayoff(balance, annualRate, monthlyPayment) {
  if (!balance || !monthlyPayment) return null;
  const r = annualRate / 100 / 12;
  if (r === 0) {
    const months = Math.ceil(balance / monthlyPayment);
    return { months, totalInterest: 0 };
  }
  if (monthlyPayment <= balance * r) return null;
  const months = Math.ceil(-Math.log(1 - (balance * r) / monthlyPayment) / Math.log(1 + r));
  const totalPaid = monthlyPayment * months;
  return { months, totalInterest: Math.max(0, totalPaid - balance) };
}

function payoffDateStr(months) {
  if (!months) return 'Never';
  const d = new Date(); d.setDate(1);
  d.setMonth(d.getMonth() + months);
  return d.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
}

function calcAccountPreview() {
  const balance = parseFloat(document.getElementById('acct-balance').value) || 0;
  const rate = parseFloat(document.getElementById('acct-rate').value) || 0;
  const payment = parseFloat(document.getElementById('acct-payment').value) || 0;
  const preview = document.getElementById('acct-preview');
  if (!balance || !payment) { preview.style.display='none'; return; }
  preview.style.display = 'block';
  const result = calcPayoff(balance, rate, payment);
  document.getElementById('preview-payoff').textContent = result ? payoffDateStr(result.months) : 'Payment too low';
  document.getElementById('preview-interest').textContent = result ? fmt(result.totalInterest) : '‚Äî';
}

function openAccountModal(id) {
  document.getElementById('account-edit-id').value = id || '';
  document.getElementById('acct-preview').style.display = 'none';
  if (id) {
    const acct = (state.accounts||[]).find(a=>a.id===id);
    if (!acct) return;
    document.getElementById('account-modal-title').textContent = 'Edit Account';
    document.getElementById('acct-name').value = acct.name;
    document.getElementById('acct-type').value = acct.type;
    document.getElementById('acct-balance').value = acct.balance;
    document.getElementById('acct-rate').value = acct.rate;
    document.getElementById('acct-payment').value = acct.payment;
    document.getElementById('acct-original').value = acct.original || '';
    document.getElementById('acct-start').value = acct.start || '';
    calcAccountPreview();
  } else {
    document.getElementById('account-modal-title').textContent = 'Add Account';
    document.getElementById('acct-name').value = '';
    document.getElementById('acct-type').value = 'mortgage';
    document.getElementById('acct-balance').value = '';
    document.getElementById('acct-rate').value = '';
    document.getElementById('acct-payment').value = '';
    document.getElementById('acct-original').value = '';
    document.getElementById('acct-start').value = new Date().toISOString().split('T')[0];
  }
  document.getElementById('account-modal').classList.add('open');
}
function closeAccountModal() { document.getElementById('account-modal').classList.remove('open'); }

function saveAccount() {
  const name = document.getElementById('acct-name').value.trim();
  const type = document.getElementById('acct-type').value;
  const balance = parseFloat(document.getElementById('acct-balance').value);
  const rate = parseFloat(document.getElementById('acct-rate').value) || 0;
  const payment = parseFloat(document.getElementById('acct-payment').value);
  const original = parseFloat(document.getElementById('acct-original').value) || balance;
  const start = document.getElementById('acct-start').value;
  if (!name || !balance || !payment) return alert('Please fill Name, Balance and Monthly Payment');
  if (!state.accounts) state.accounts = [];
  const editId = document.getElementById('account-edit-id').value;
  if (editId) {
    const idx = state.accounts.findIndex(a=>a.id===editId);
    if (idx>=0) state.accounts[idx] = { ...state.accounts[idx], name, type, balance, rate, payment, original, start };
  } else {
    state.accounts.push({ id:'acct'+Date.now(), name, type, balance, rate, payment, original, start, paymentOverrides:{} });
  }
  save(); closeAccountModal(); renderAccounts();
}

function deleteAccount(id) {
  if (!confirm('Delete this account?')) return;
  state.accounts = (state.accounts||[]).filter(a=>a.id!==id);
  save(); renderAccounts();
}

// ‚îÄ‚îÄ Amortization Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let amortAcctId = null, amortActiveTab = 'schedule';

function openAmort(id) {
  amortAcctId = id;
  amortActiveTab = 'schedule';
  document.querySelectorAll('.amort-tab').forEach((t,i)=>t.classList.toggle('active',i===0));
  const acct = (state.accounts||[]).find(a=>a.id===id);
  if (!acct) return;
  document.getElementById('amort-modal-title').textContent = acct.name;
  document.getElementById('amort-modal-sub').textContent = `${ACCT_LABELS[acct.type]} ¬∑ ${acct.rate}% APR ¬∑ ${fmt(acct.payment)}/mo`;
  renderAmortBody();
  document.getElementById('amort-overlay').classList.add('open');
}
function closeAmort() { document.getElementById('amort-overlay').classList.remove('open'); }
function switchAmortTab(tab, btn) {
  amortActiveTab = tab;
  document.querySelectorAll('.amort-tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  renderAmortBody();
}

function renderAmortBody() {
  const acct = (state.accounts||[]).find(a=>a.id===amortAcctId);
  if (!acct) return;
  const overrides = acct.paymentOverrides || {};
  const schedule = buildSchedule(acct.balance, acct.rate, acct.payment, acct.start, overrides);
  const stats = scheduleStats(schedule);

  if (amortActiveTab === 'schedule') {
    renderAmortSchedule(acct, schedule, stats);
  } else {
    renderAmortScenarios(acct, schedule, stats);
  }
}

function renderAmortSchedule(acct, schedule, stats) {
  const body = document.getElementById('amort-body');
  // Group by year
  const years = {};
  schedule.forEach(row => {
    const y = row.date.getFullYear();
    if (!years[y]) years[y] = [];
    years[y].push(row);
  });

  const totalInterest = stats.totalInterest;
  const payoffDate = stats.payoffDate ? stats.payoffDate.toLocaleDateString('en-US',{month:'short',year:'numeric'}) : '‚Äî';
  const customPayments = Object.keys(acct.paymentOverrides||{}).length;

  body.innerHTML = `
    <div class="amort-summary">
      <div class="amort-stat"><div class="as-label">Payoff</div><div class="as-value" style="font-size:0.85rem;color:var(--gold)">${payoffDate}</div></div>
      <div class="amort-stat"><div class="as-label">Total Interest</div><div class="as-value" style="color:var(--red);font-size:0.85rem;">${fmt(totalInterest)}</div></div>
      <div class="amort-stat"><div class="as-label">Months Left</div><div class="as-value">${stats.months}</div></div>
    </div>
    <p style="font-size:0.78rem;color:var(--text2);margin-bottom:12px;">Tap ‚úèÔ∏è on any payment to record the actual amount paid ‚Äî extra payments reduce your balance and shorten the loan.</p>
    <div class="amort-col-hdr">
      <span>#</span><span>Month</span><span style="text-align:right">Payment</span><span style="text-align:right">Principal</span><span style="text-align:right">Balance</span>
    </div>
    ${Object.keys(years).sort().map(yr => {
      const rows = years[yr];
      const yrInterest = rows.reduce((s,r)=>s+r.interest,0);
      const yrPrincipal = rows.reduce((s,r)=>s+r.principal,0);
      const hasOverride = rows.some(r=>r.isOverride);
      const isCurrentYear = parseInt(yr) === new Date().getFullYear();
      return `<div class="amort-year-group">
        <div class="amort-year-header" onclick="toggleAmortYear('y${yr}')">
          <span class="amort-year-label">${yr}</span>
          <span class="amort-year-meta">${fmt(yrPrincipal)} principal ¬∑ ${fmt(yrInterest)} interest${hasOverride?' ¬∑ ‚úèÔ∏è':''}</span>
          <span class="amort-year-toggle${isCurrentYear?' open':''}" id="ytog-y${yr}">‚ñº</span>
        </div>
        <div class="amort-rows${isCurrentYear?' open':''}" id="y${yr}">
          ${rows.map((row, i) => {
            const rowNum = schedule.indexOf(row)+1;
            const monthLabel = row.date.toLocaleDateString('en-US',{month:'short',year:'2-digit'});
            const overrideBadge = row.isOverride
              ? (row.payment > row.scheduledPayment
                  ? `<span class="amort-badge extra">+${fmt(row.payment-row.scheduledPayment)}</span>`
                  : row.payment < row.scheduledPayment
                    ? `<span class="amort-badge reduced">${fmt(row.payment-row.scheduledPayment)}</span>`
                    : '')
              : '';
            return `<div class="amort-row${row.isCurrentMonth?' current-month':''}${row.isPast?' paid':''}${row.isOverride?' custom-payment':''}">
              <span style="color:var(--text2);font-size:0.7rem">${rowNum}</span>
              <span>${monthLabel}${overrideBadge}</span>
              <span style="text-align:right" id="amort-pmt-cell-${row.monthKey}">
                <span class="amort-pmt-cell">
                  <span>${fmt(row.payment)}</span>
                  <button class="amort-edit-btn" onclick="startEditPayment('${amortAcctId}','${row.monthKey}',${row.payment})" title="Edit payment">‚úèÔ∏è</button>
                  ${row.isOverride ? `<button class="amort-edit-btn" onclick="clearPaymentOverride('${amortAcctId}','${row.monthKey}')" title="Reset to scheduled" style="color:var(--red)">‚úï</button>` : ''}
                </span>
              </span>
              <span style="text-align:right;color:var(--green)">${fmt(row.principal)}</span>
              <span style="text-align:right">${fmt(row.balance)}</span>
            </div>`;
          }).join('')}
        </div>
      </div>`;
    }).join('')}
  `;
}

function renderAmortScenarios(acct, baseSchedule, baseStats) {
  const body = document.getElementById('amort-body');
  const basePayoff = baseStats.payoffDate;
  const baseInterest = baseStats.totalInterest;
  const baseMonths = baseStats.months;

  function scenario(label, payment) {
    const s = buildSchedule(acct.balance, acct.rate, payment, acct.start, {});
    const st = scheduleStats(s);
    const savedMonths = baseMonths - st.months;
    const savedInterest = baseInterest - st.totalInterest;
    const payoffStr = st.payoffDate ? st.payoffDate.toLocaleDateString('en-US',{month:'short',year:'numeric'}) : 'Never';
    return `<div class="scenario-row">
      <div>
        <div class="scenario-name">${label}</div>
        <div style="font-size:0.72rem;color:var(--text2)">${fmt(payment)}/mo</div>
      </div>
      <div class="scenario-details">
        <div class="scenario-date">${payoffStr}</div>
        ${savedMonths>0 ? `<div class="scenario-saving">Save ${Math.floor(savedMonths/12)}yr ${savedMonths%12}mo ¬∑ ${fmt(savedInterest)}</div>` : ''}
      </div>
    </div>`;
  }

  body.innerHTML = `
    <div class="amort-summary">
      <div class="amort-stat"><div class="as-label">Current</div><div class="as-value" style="font-size:0.85rem">${fmt(acct.payment)}/mo</div></div>
      <div class="amort-stat"><div class="as-label">Payoff</div><div class="as-value" style="font-size:0.85rem;color:var(--gold)">${basePayoff?basePayoff.toLocaleDateString('en-US',{month:'short',year:'numeric'}):'‚Äî'}</div></div>
      <div class="amort-stat"><div class="as-label">Total Interest</div><div class="as-value" style="color:var(--red);font-size:0.85rem">${fmt(baseInterest)}</div></div>
    </div>
    <div class="scenario-compare">
      <h3>Payment Scenarios vs. Current</h3>
      ${scenario('Current (baseline)', acct.payment)}
      ${scenario('Double Payment', acct.payment * 2)}
      ${scenario('+$100/mo', acct.payment + 100)}
      ${scenario('+$200/mo', acct.payment + 200)}
      ${scenario('+$500/mo', acct.payment + 500)}
      ${acct.payment > 100 ? scenario('‚àí$100/mo (risk)', Math.max(50, acct.payment - 100)) : ''}
    </div>
    <div class="scenario-compare">
      <h3>Custom Payment Calculator</h3>
      <div class="scenario-custom-row">
        <input type="number" id="scenario-custom-input" placeholder="Enter monthly payment $" min="0" step="1" oninput="calcScenarioCustom('${acct.id}')" />
      </div>
      <div class="scenario-custom-result" id="scenario-custom-result"></div>
    </div>
  `;
}

function calcScenarioCustom(id) {
  const acct = (state.accounts||[]).find(a=>a.id===id);
  if (!acct) return;
  const pmt = parseFloat(document.getElementById('scenario-custom-input').value) || 0;
  const result = document.getElementById('scenario-custom-result');
  if (!pmt) { result.style.display='none'; return; }
  const s = buildSchedule(acct.balance, acct.rate, pmt, acct.start, {});
  const st = scheduleStats(s);
  const base = buildSchedule(acct.balance, acct.rate, acct.payment, acct.start, {});
  const bst = scheduleStats(base);
  const saved = bst.months - st.months;
  const savedInt = bst.totalInterest - st.totalInterest;
  if (!st.payoffDate) { result.style.display='block'; result.innerHTML='<span style="color:var(--red)">Payment too low to pay off loan</span>'; return; }
  result.style.display = 'block';
  result.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
      <div style="text-align:center"><div style="font-size:0.68rem;color:var(--text2);margin-bottom:4px">PAYOFF DATE</div><div style="font-weight:700;color:var(--gold)">${st.payoffDate.toLocaleDateString('en-US',{month:'short',year:'numeric'})}</div></div>
      <div style="text-align:center"><div style="font-size:0.68rem;color:var(--text2);margin-bottom:4px">TOTAL INTEREST</div><div style="font-weight:700;color:var(--red)">${fmt(st.totalInterest)}</div></div>
    </div>
    ${saved > 0 ? `<div style="text-align:center;color:var(--green);font-size:0.82rem;font-weight:600">Save ${Math.floor(saved/12)}yr ${saved%12}mo ¬∑ ${fmt(savedInt)} in interest</div>` : saved < 0 ? `<div style="text-align:center;color:var(--red);font-size:0.82rem">Adds ${Math.abs(Math.floor(saved/12))}yr ${Math.abs(saved%12)}mo ¬∑ ${fmt(Math.abs(savedInt))} more interest</div>` : ''}
  `;
}

function toggleAmortYear(id) {
  const el = document.getElementById(id);
  const tog = document.getElementById('ytog-'+id);
  if (!el) return;
  el.classList.toggle('open');
  tog.classList.toggle('open');
}

function startEditPayment(acctId, monthKey, currentAmt) {
  const cellId = 'amort-pmt-cell-'+monthKey;
  const cell = document.getElementById(cellId);
  if (!cell) return;
  cell.innerHTML = `
    <span class="amort-pmt-cell" style="flex-wrap:wrap;gap:4px;">
      <input class="amort-edit-input" id="edit-input-${monthKey}" type="number" value="${currentAmt.toFixed(2)}" min="0" step="0.01" />
      <button class="amort-save-btn" onclick="savePaymentOverride('${acctId}','${monthKey}')">Save</button>
      <button class="amort-cancel-btn" onclick="renderAmortBody()">Cancel</button>
    </span>`;
  document.getElementById('edit-input-'+monthKey).focus();
  document.getElementById('edit-input-'+monthKey).select();
}

function savePaymentOverride(acctId, monthKey) {
  const acct = (state.accounts||[]).find(a=>a.id===acctId);
  if (!acct) return;
  const val = parseFloat(document.getElementById('edit-input-'+monthKey).value);
  if (isNaN(val) || val < 0) return alert('Enter a valid payment amount');
  if (!acct.paymentOverrides) acct.paymentOverrides = {};
  acct.paymentOverrides[monthKey] = val;
  // Update the account's current balance based on past overrides
  save();
  renderAmortBody();
  renderAccounts();
}

function clearPaymentOverride(acctId, monthKey) {
  const acct = (state.accounts||[]).find(a=>a.id===acctId);
  if (!acct || !acct.paymentOverrides) return;
  delete acct.paymentOverrides[monthKey];
  save();
  renderAmortBody();
  renderAccounts();
}

function renderAccounts() {
  if (!state.accounts) state.accounts = [];
  const list = document.getElementById('accounts-list');
  const summary = document.getElementById('acct-summary');
  if (!list || !summary) return;

  if (!state.accounts.length) {
    summary.innerHTML = '';
    list.innerHTML = `<div class="card"><div class="empty"><div class="empty-icon">üè¶</div><p>No accounts yet.<br>Tap + to add a mortgage, car loan, or any debt.</p></div></div>`;
    return;
  }

  const totalDebt = state.accounts.reduce((s,a)=>s+a.balance,0);
  const totalMonthly = state.accounts.reduce((s,a)=>s+a.payment,0);
  const avgRate = state.accounts.reduce((s,a)=>s+a.rate,0) / state.accounts.length;

  summary.innerHTML = `
    <div class="acct-summary-card"><div class="label">Total Debt</div><div class="value" style="color:var(--red);font-size:0.95rem;">${fmt(totalDebt)}</div></div>
    <div class="acct-summary-card"><div class="label">Monthly</div><div class="value" style="font-size:0.95rem;">${fmt(totalMonthly)}</div></div>
    <div class="acct-summary-card"><div class="label">Avg Rate</div><div class="value" style="font-size:0.95rem;">${avgRate.toFixed(2)}%</div></div>
  `;

  list.innerHTML = state.accounts.map(acct => {
    const overrides = acct.paymentOverrides || {};
    const schedule = buildSchedule(acct.balance, acct.rate, acct.payment, acct.start, overrides);
    const stats = scheduleStats(schedule);
    const paidPct = acct.original ? Math.min(100, ((acct.original - acct.balance) / acct.original) * 100) : 0;
    const payoffStr = stats.payoffDate ? stats.payoffDate.toLocaleDateString('en-US',{month:'short',year:'numeric'}) : '‚Äî';
    const customPmtCount = Object.keys(overrides).length;

    return `<div class="account-card ${acct.type}">
      <div class="account-top">
        <div>
          <div class="account-name">${ACCT_ICONS[acct.type]||'üí∞'} ${escHtml(acct.name)}</div>
          <div class="account-type-badge">${ACCT_LABELS[acct.type]||'Loan'} ¬∑ ${acct.rate}% APR</div>
        </div>
        <div class="account-actions">
          <button class="account-action-btn" onclick="openAmort('${acct.id}')" title="Amortization Schedule" style="font-size:0.75rem;width:auto;padding:0 10px;letter-spacing:0.5px;font-weight:600;color:var(--gold);">üìÖ Schedule</button>
          <button class="account-action-btn" onclick="openAccountModal('${acct.id}')" title="Edit">‚úèÔ∏è</button>
          <button class="account-action-btn" onclick="deleteAccount('${acct.id}')" title="Delete">üóë</button>
        </div>
      </div>
      <div class="account-balance">${fmt(acct.balance)}</div>
      <div class="account-meta">
        <div class="account-meta-item"><strong>${fmt(acct.payment)}/mo</strong>Payment</div>
        ${acct.original ? `<div class="account-meta-item"><strong>${paidPct.toFixed(1)}%</strong>Paid off</div>` : ''}
        <div class="account-meta-item"><strong>${payoffStr}</strong>Payoff</div>
        ${customPmtCount ? `<div class="account-meta-item"><strong>${customPmtCount}</strong>Custom pmts</div>` : ''}
      </div>
      ${acct.original ? `
        <div class="account-progress"><div class="account-progress-fill" style="width:${paidPct}%"></div></div>
        <div class="account-progress-label"><span>${fmt(acct.original - acct.balance)} paid</span><span>${fmt(acct.original)} original</span></div>` : ''}
      <div class="payoff-box">
        <div class="payoff-box-title">Quick Payoff Scenarios</div>
        <div class="payoff-scenarios">
          ${[['Min Payment',acct.payment,false],['2√ó Payment',acct.payment*2,true],['+$100/mo',acct.payment+100,false],['+$500/mo',acct.payment+500,false]].map(([label,pmt,hi])=>{
            const s=buildSchedule(acct.balance,acct.rate,pmt,acct.start,{});
            const st=scheduleStats(s);
            const saved=stats.months-st.months;
            const savedInt=stats.totalInterest-st.totalInterest;
            const dateStr=st.payoffDate?st.payoffDate.toLocaleDateString('en-US',{month:'short',year:'numeric'}):'Never';
            return `<div class="payoff-scenario${hi?' highlight':''}">
              <div class="ps-label">${label}</div>
              <div class="ps-date">${dateStr}</div>
              ${saved>0?`<div class="ps-savings">Save ${Math.floor(saved/12)}yr ${saved%12}mo<br>${fmt(savedInt)}</div>`:''}
            </div>`;
          }).join('')}
        </div>
      </div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ Category Manager ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CAT_COLORS = ['#e05c6a','#c9a84c','#e8c97a','#4caf82','#5b7fde','#8a6de0','#e07c3a','#3ab8c9','#c94c8a','#7dba5b','#8892a4','#de5b5b'];
let newCatType = 'expense', selectedColor = CAT_COLORS[0];

function openCatManager() {
  newCatType = 'expense';
  selectedColor = CAT_COLORS[0];
  document.getElementById('newcat-name').value='';
  document.getElementById('newcat-icon').value='';
  document.getElementById('newcat-expense-btn').classList.add('active');
  document.getElementById('newcat-income-btn').classList.remove('active');
  renderColorGrid();
  renderCatManagerList();
  document.getElementById('cat-modal').classList.add('open');
}
function closeCatManager() { document.getElementById('cat-modal').classList.remove('open'); }
function setNewCatType(type) {
  newCatType = type;
  document.getElementById('newcat-expense-btn').classList.toggle('active', type==='expense');
  document.getElementById('newcat-income-btn').classList.toggle('active', type==='income');
}
function renderColorGrid() {
  document.getElementById('color-grid').innerHTML = CAT_COLORS.map(c=>`<div class="color-swatch ${c===selectedColor?'selected':''}" style="background:${c}" onclick="selectColor('${c}')"></div>`).join('');
}
function selectColor(c) { selectedColor=c; renderColorGrid(); }
function saveNewCategory() {
  const name=document.getElementById('newcat-name').value.trim();
  const icon=document.getElementById('newcat-icon').value.trim()||'üè∑Ô∏è';
  if (!name) return alert('Enter a category name');
  if (!state.customCategories) state.customCategories=[];
  if (getAllCategories().find(c=>c.name===name)) return alert('A category with that name already exists');
  state.customCategories.push({name,icon,color:selectedColor,type:newCatType,custom:true});
  save();
  document.getElementById('newcat-name').value='';
  document.getElementById('newcat-icon').value='';
  renderCatManagerList();
  renderAll();
}
function deleteCustomCategory(name) {
  if (!confirm(`Delete category "${name}"? Existing transactions won't be affected.`)) return;
  state.customCategories = (state.customCategories||[]).filter(c=>c.name!==name);
  save(); renderCatManagerList(); renderAll();
}
function renderCatManagerList() {
  const all = getAllCategories();
  document.getElementById('cat-manager-list').innerHTML = all.map(c=>`
    <div class="cat-manage-row">
      <div class="cat-swatch" style="background:${c.color}20;">${c.icon}</div>
      <div class="cat-manage-name">${escHtml(c.name)}</div>
      <span class="cat-manage-type ${c.type}">${c.type}</span>
      ${c.custom?`<button class="cat-del-btn" onclick="deleteCustomCategory('${escHtml(c.name).replace(/'/g,"\\'")}')">üóë</button>`:`<span style="width:28px;"></span>`}
    </div>`).join('');
}

renderAll();

// ‚îÄ‚îÄ PWA: Inline Manifest ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function(){
  const manifest = {
    name: "Vault ‚Äî Budget App",
    short_name: "Vault",
    description: "Personal budget tracker",
    start_url: "./",
    display: "fullscreen",
    background_color: "#0d0f14",
    theme_color: "#c9a84c",
    orientation: "portrait",
    icons: [
      {
        src: "data:image/svg+xml," + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' rx='32' fill='#0d0f14'/><rect x='36' y='80' width='120' height='80' rx='12' fill='#c9a84c'/><rect x='56' y='60' width='80' height='40' rx='10' fill='#c9a84c'/><circle cx='130' cy='120' r='14' fill='#0d0f14'/><circle cx='130' cy='120' r='7' fill='#c9a84c'/></svg>`),
        sizes: "192x192",
        type: "image/svg+xml",
        purpose: "any maskable"
      },
      {
        src: "data:image/svg+xml," + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' rx='80' fill='#0d0f14'/><rect x='96' y='213' width='320' height='213' rx='32' fill='#c9a84c'/><rect x='149' y='160' width='213' height='107' rx='27' fill='#c9a84c'/><circle cx='347' cy='320' r='37' fill='#0d0f14'/><circle cx='347' cy='320' r='19' fill='#c9a84c'/></svg>`),
        sizes: "512x512",
        type: "image/svg+xml",
        purpose: "any maskable"
      }
    ]
  };
  const blob = new Blob([JSON.stringify(manifest)], {type: 'application/manifest+json'});
  document.getElementById('pwa-manifest').href = URL.createObjectURL(blob);
})();

// ‚îÄ‚îÄ PWA: Service Worker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if ('serviceWorker' in navigator) {
  const swCode = `
    const CACHE = 'vault-v1';
    self.addEventListener('install', e => {
      self.skipWaiting();
    });
    self.addEventListener('activate', e => {
      self.clients.claim();
    });
    self.addEventListener('fetch', e => {
      // Cache-first for same-origin, network-first for external
      if (e.request.url.startsWith(self.location.origin)) {
        e.respondWith(
          caches.open(CACHE).then(cache =>
            cache.match(e.request).then(cached =>
              cached || fetch(e.request).then(resp => {
                cache.put(e.request, resp.clone());
                return resp;
              })
            )
          )
        );
      }
    });
  `;
  const swBlob = new Blob([swCode], {type: 'application/javascript'});
  const swUrl = URL.createObjectURL(swBlob);
  navigator.serviceWorker.register(swUrl, {scope: './'}).catch(() => {});
}
</script>
</body>
</html>
